<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- OPTIMASI PERFORMA ANDROID -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <title>Treasure Map â€” Mystery Box (Pulau A)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    /* OPTIMASI PERFORMA ANDROID */
    *{
      -webkit-tap-highlight-color:transparent;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
      box-sizing:border-box;
    }
    
    html,body{
      -webkit-text-size-adjust:100%;
      -ms-text-size-adjust:100%;
      text-size-adjust:100%;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-display:swap;
      overscroll-behavior:none;
    }
    
    /* HARDWARE ACCELERATION */
    .mystery-box, .box-glow, button {
      transform:translateZ(0);
      -webkit-transform:translateZ(0);
      will-change:transform;
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
    }
    
    /* OPTIMASI TOUCH */
    button, .mystery-box {
      touch-action:manipulation;
      cursor:pointer;
    }
    
    /* DISABLE HOVER ON TOUCH */
    @media (hover: none) and (pointer: coarse) {
      button:hover, .mystery-box:hover {
        transform:none !important;
        filter:none !important;
      }
    }
    
    body{ font-family:'Inter',sans-serif; background:#121212; color:#fff }
    .mystery-root{
      position:relative; min-height:calc(100vh - 66px - 64px); padding-bottom:24px;
      background:#121212;
      background-image:conic-gradient(from 0deg at 50% 50%, #ff00ff 0%, #ff00ff 10%, #ff9900 20%, #ffff00 30%, #00ff00 40%, #00ffff 50%, #0000ff 60%, #9900ff 70%, #ff00ff 80%, #ff00ff 100%);
      background-size:200% 200%; animation:rainbow-bg-shift 20s linear infinite; overflow-x:hidden;
    }
    @keyframes rainbow-bg-shift{ 0%{background-position:0% 0%} 50%{background-position:100% 100%} 100%{background-position:0% 0%} }

    .box-glow{ --angle:0deg; background:conic-gradient(from var(--angle) at 50% 50%, #ff00ff,#ff9900,#ffff00,#00ff00,#00ffff,#0000ff,#9900ff,#ff00ff);
      animation:rotate-gradient 3s linear infinite; position:relative; border-radius:1rem;
      box-shadow:0 0 24px rgba(255,0,255,.4),0 6px 22px rgba(255,255,255,.2); transition:box-shadow .2s, transform .12s; will-change:transform;
    }
    .box-glow::before{ content:""; position:absolute; inset:0; border-radius:1rem; background:rgba(18,18,18,.7); border:2px solid #1a1a1a; z-index:1; }
    .box-glow > span{ position:relative; z-index:2 }
    .box-glow:hover{ transform:scale(1.06) rotate(-2deg); box-shadow:0 0 44px 12px rgba(255,0,255,.8),0 0 20px rgba(255,153,0,.8),0 0 0 2px #fff inset; }
    @keyframes rotate-gradient{ to{ --angle:360deg } }
    .rainbow-neon{ text-shadow:0 0 8px #fff,0 0 12px #ff00ff,0 0 20px #0000ff,0 0 30px #00ffff,0 0 40px #00ff00; }
    .fade-in{ animation:fadein .35s ease }
    @keyframes fadein{ from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:translateY(0)} }
    .modal-bg{ background:rgba(0,0,0,.7); backdrop-filter:blur(3px) }
    .table th{ background:#4b0082; color:#fff }
    .table td,.table th{ border-bottom:1px solid rgba(255,255,255,.1) }
    .highlight{ background-image:linear-gradient(90deg,#ff00ff,#00ffff); color:#fff; font-weight:700 }
    .picked{ outline:4px solid #22d3ee; box-shadow:0 0 30px #22d3ee77 inset }
    .disabled{ pointer-events:none; opacity:.6 }
    #btnSpin.disabled{ 
      background:linear-gradient(to right, #6b7280, #9ca3af) !important;
      cursor:not-allowed !important;
      transform:none !important;
    }
    .twirl{ transform:rotateY(180deg) scale(.96) }
    .header-full{left:0;right:0;top:0;width:100% !important;}
  </style>
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden mystery" style="overflow-y:auto;">

  <!-- HEADER -->
  <header class="header-full fixed z-50 p-0 m-0">
    <nav class="w-full bg-gradient-to-r from-slate-900 via-indigo-900 to-purple-900 shadow-md">
      <div class="w-full flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
        <a href="#" class="text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">BELEGENDBET</a>
        <!-- (Info User/Kupon/Pulau DIHAPUS) -->
        <button id="btnHome" class="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 font-semibold shadow">Beranda</button>
      </div>
    </nav>
  </header>
  <div class="h-16"></div>

  <div class="mystery-root">
    <main class="w-full flex flex-col items-center pt-8 pb-28">
      <h1 class="text-4xl md:text-6xl font-extrabold rainbow-neon tracking-widest uppercase drop-shadow-lg mb-6 text-center"> MYSTERY BOX </h1>

      <div id="gridBoxes" class="grid grid-cols-3 gap-6 mb-8">
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
        <button class="box-glow w-20 h-20 md:w-28 md:h-28 flex items-center justify-center"><span class="text-4xl md:text-5xl">ğŸ</span></button>
      </div>

      <div class="flex flex-col items-center gap-3">
        <button id="btnSpin" class="px-10 py-3 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-500 rounded-full text-white text-lg md:text-xl font-bold shadow-xl hover:scale-105 transition-all uppercase tracking-widest border-2 border-amber-300/50">ğŸ² SPIN BOX</button>
        <button id="btnShow" class="flex items-center gap-2 px-8 py-3 bg-green-500 hover:bg-green-600 transition-all rounded-full text-white text-base md:text-lg font-semibold shadow-lg"><span>ğŸ</span> Tampilkan Hadiah</button>
      </div>

      <div class="mt-6 flex justify-center w-full">
        <span class="text-base md:text-2xl font-bold px-3 py-2 rounded-xl bg-red-600 text-white border-2 border-red-400 shadow-md shadow-red-500/50 w-full max-w-xs sm:max-w-md md:max-w-lg text-center whitespace-normal break-words">ğŸ‰Buka kotak hadiah dan dapatkan bonus spektakulerğŸ“Œ</span>
      </div>

      <section id="listHadiah" class="w-full max-w-[820px] mx-auto mt-6 hidden fade-in">
        <div id="hadiahWrap" class="grid grid-cols-3 gap-4 place-items-center"></div>
      </section>
    </main>

    <div id="modalPrize" class="fixed inset-0 hidden items-center justify-center z-50 modal-bg">
      <div class="relative bg-[#1b1e2a] rounded-2xl shadow-2xl border border-white/10 w-[90%] max-w-xl p-6">
        <h3 class="text-center text-2xl font-extrabold text-yellow-300 mb-4">Hadiah Mystery Box</h3>
        <div class="overflow-hidden rounded-xl border border-white/10">
          <table class="w-full table text-left text-white">
            <thead><tr><th class="py-3 px-4 w-16">No</th><th class="py-3 px-4">Hadiah</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div id="resultText" class="text-center text-lg font-bold text-yellow-300 mt-4"></div>
        <div class="flex justify-between gap-3 mt-5">
          <a id="btnClaimWA" href="https://klikblg.com/wa-blb" target="_blank" rel="noopener" class="flex-1 px-2 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow text-center mr-2">CLAIM WA</a>
          <button id="btnCloseModal" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow">Tutup</button>
          <a id="btnClaimTG" href="https://t.me/asupanfreebet" target="_blank" rel="noopener" class="flex-1 px-2 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow text-center ml-2">CLAIM TELEGRAM</a>
        </div>
        <button id="btnCloseModal2" class="absolute -top-3 -right-3 bg-red-500 text-white w-9 h-9 rounded-full font-bold shadow">âœ•</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w-full bg-gradient-to-r from-slate-900 via-indigo-900 to-purple-900 shadow-md py-5 relative">
    <div class="w-full flex items-center justify-center gap-3 px-3 sm:px-6">
      <p class="text-gray-300 text-sm">&copy;  2025 BELEGENDBET. Hak Cipta Dilindungi Undang-Undang.</p>
    </div>
  </footer>

  <script>
    /* ==== OPTIMASI PERFORMA ANDROID SUPER NGEBUT ==== */
    // Disable console di production untuk speed
    if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      console.log = console.warn = console.error = () => {};
    }

    // Fast event delegation untuk touch events
    const addTouchOptimized = (element, handler) => {
      if (element) {
        element.addEventListener('touchstart', handler, { passive: true });
        element.addEventListener('click', handler, { passive: true });
      }
    };

    // Memory-efficient animation queue
    const animQueue = [];
    let animRunning = false;
    const runAnimations = () => {
      if (animQueue.length === 0) {
        animRunning = false;
        return;
      }
      animRunning = true;
      requestAnimationFrame(() => {
        const batch = animQueue.splice(0, 5); // Process 5 at a time
        batch.forEach(fn => fn());
        runAnimations();
      });
    };
    
    const queueAnimation = (fn) => {
      animQueue.push(fn);
      if (!animRunning) runAnimations();
    };

    /* ==== ORIGINAL SCRIPT START ==== */
  (function(){
    // Data session dipakai cuma di teks hasil (modal)
    function loadSession(){ try{ return JSON.parse(localStorage.getItem('tm_session')||'null'); }catch{ return null } }
    const s = loadSession();
    // Helper: flag claimed di localStorage per kupon
    function setClaimed(kupon) {
      if (!kupon) return;
      localStorage.setItem('tm_claimed_'+kupon, '1');
    }
    function isClaimed(kupon) {
      if (!kupon) return false;
      return localStorage.getItem('tm_claimed_'+kupon) === '1';
    }

    // Tombol beranda
    document.getElementById('btnHome')?.addEventListener('click', ()=> window.location.href='index.html');

    // Saat halaman dibuka, cek status kupon ke API
    async function checkKuponStatus() {
      if (!s?.userId || !s?.kupon) return;
      const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
      try {
        const res = await fetch(`${apiUrl}?action=claim&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`);
        const data = await res.json();
        // Jika status sudah TERPAKAI, kunci UI dan tampilkan hadiah
        if (data.msg && data.msg.toLowerCase().includes('terpakai')) {
          // Ambil hadiah dari sheet (perlu fetch manual, atau tampilkan pesan sudah pernah klaim)
          disableGame();
          document.getElementById('resultText').textContent = 'Kupon sudah pernah dipakai!';
          setClaimed(s.kupon);
        }
      } catch (e) {
        // abaikan error
      }
    }
    // Jika sudah pernah claim (localStorage), kunci UI
    if (isClaimed(s?.kupon)) {
      disableGame();
      document.getElementById('resultText').textContent = 'Kupon sudah pernah dipakai!';
    } else {
      checkKuponStatus();
    }

    // Hadiah list + pool
    const hadiahDisplay = [
      { nominal:"Rp 5.000.000", logo:"ğŸ…" },
      { nominal:"Rp 1.000.000", logo:"ğŸ‘‘" },
      { nominal:"Rp 100.000",  logo:"ğŸ’·" },
      { nominal:"Rp 20.000",   logo:"ğŸ’³" },
      { nominal:"Rp 10.000",   logo:"ğŸ¤‘" },
      { nominal:"Rp 8.000",    logo:"ğŸ’" },
      { nominal:"Rp 5.000",    logo:"ğŸ’µ" },
      { nominal:"Rp 3.000",    logo:"â­" },
      { nominal:"Rp 2.000",    logo:"ğŸ’°" },
    ];

    // Render list hadiah
    const hadiahWrap = document.getElementById('hadiahWrap');
    function renderListHadiah(){
      hadiahWrap.innerHTML='';
      hadiahDisplay.forEach(h=>{
        const card=document.createElement('div');
        card.className='w-[110px] md:w-[150px] h-[88px] md:h-[104px] flex flex-col items-center justify-center bg-yellow-100 rounded-xl shadow-md border border-yellow-400/30';
        card.innerHTML = `<span class="text-2xl md:text-3xl mb-1">${h.logo}</span><span class="text-[13px] md:text-[16px] font-bold text-yellow-800">${h.nominal}</span>`;
        hadiahWrap.appendChild(card);
      });
    }
    renderListHadiah();

    document.getElementById('btnShow')?.addEventListener('click', ()=>{
      const el=document.getElementById('listHadiah');
      el.classList.toggle('hidden');
      if(!el.classList.contains('hidden')) el.classList.add('fade-in');
    });

    // Shuffle grid
    const grid = document.getElementById('gridBoxes');
    let spinning=false, chosen=false, hasSpun=false;

    // Saat load, semua box harus disabled
    function setBoxesDisabled(disabled=true) {
      Array.from(grid.children).forEach(b => {
        if (disabled) {
          b.classList.add('disabled');
          b.style.pointerEvents = 'none';
        } else {
          b.classList.remove('disabled');
          b.style.pointerEvents = 'auto';
        }
      });
    }
    // Inisialisasi: box tidak bisa dipilih sebelum spin
    setBoxesDisabled(true);

    function rotateRowsRight(){ const k=Array.from(grid.children); [k[2],k[0],k[1], k[5],k[3],k[4], k[8],k[6],k[7]].forEach(el=>grid.appendChild(el)); }
    function rotateColsDown(){ const k=Array.from(grid.children); [k[6],k[7],k[8], k[0],k[1],k[2], k[3],k[4],k[5]].forEach(el=>grid.appendChild(el)); }
    function randomSwapPairs(){ const k=Array.from(grid.children); const swaps=2+Math.floor(Math.random()*2);
      for(let s=0;s<swaps;s++){ let a=Math.floor(Math.random()*9), b=Math.floor(Math.random()*9);
        if(a===b) b=(b+1)%9; if(a>b){const t=a;a=b;b=t;}
        grid.insertBefore(k[b], k[a]); grid.insertBefore(k[a], k[b+1]||null);
      }
    }
    function flipShuffle(){
      const items=Array.from(grid.children);
      const first=new Map(items.map(el=>[el, el.getBoundingClientRect()]));
      const r=Math.random(); if(r<0.34) rotateRowsRight(); else if(r<0.68) rotateColsDown(); else randomSwapPairs();
      const after=Array.from(grid.children);
      after.forEach(el=>{
        const f=first.get(el), l=el.getBoundingClientRect();
        const dx=f.left-l.left, dy=f.top-l.top;
        el.style.transform=`translate(${dx}px,${dy}px)`; el.style.transition='transform 0s';
        if(Math.random()<0.25) el.classList.add('twirl');
        requestAnimationFrame(()=>{
          el.style.transition='transform 240ms cubic-bezier(.22,.9,.24,.99)';
          el.style.transform='translate(0,0)';
          setTimeout(()=> el.classList.remove('twirl'),240);
        });
      });
    }

    const btnSpin=document.getElementById('btnSpin');
    function startSpinBoxes(){
      if(spinning || hasSpun) return; // Cegah spin jika sudah pernah spin
      spinning=true; chosen=false; hasSpun=true; // Set flag hasSpun ke true
      
      // MULAI SUARA JACKPOT REEL UNTUK SPIN
      startJackpotReelSound();
      
      Array.from(grid.children).forEach(b=>{
        b.classList.remove('picked','disabled');
        b.style.pointerEvents='none';
        b.querySelector('span').textContent='ğŸ';
      });
      setBoxesDisabled(true);
      
      // Disable tombol spin dan ubah tampilannya
      btnSpin.disabled = true;
      btnSpin.classList.add('disabled');
      
      const endAt=Date.now()+3000;
      (function step(){
        if(Date.now()>endAt){
          // STOP SUARA JACKPOT REEL SETELAH SELESAI SPIN
          stopJackpotReelSound();
          btnSpin.textContent='ğŸ¯ PILIH KOTAK!';
          setBoxesDisabled(false);
          spinning=false; return;
        }
        btnSpin.textContent='âš¡ MENGACAKâ€¦';
        flipShuffle();
        setTimeout(step, 60+Math.random()*50);
      })();
    }
    function formatRupiah(n){ return 'Rp '+n.toLocaleString('id-ID'); }
    btnSpin?.addEventListener('click', startSpinBoxes);

    const tbody=document.getElementById('tableBody');
  function openModalWithPrize(prize){
      // PLAY CHA-CHING SOUND UNTUK HADIAH
      playChaChing();
      
      tbody.innerHTML='';
      hadiahDisplay.forEach((h,i)=>{
        const tr=document.createElement('tr');
        const nominalNumber=Number(h.nominal.replace(/\D/g,''));
        tr.innerHTML = `<td class="py-2 px-4">${i+1}</td><td class="py-2 px-4">${h.nominal}</td>`;
        if(nominalNumber===prize) tr.classList.add('highlight');
        tbody.appendChild(tr);
      });
      // Update link WA dan Telegram dengan pesan hadiah
      const btnClaimWA = document.getElementById('btnClaimWA');
      const btnClaimTG = document.getElementById('btnClaimTG');
      if(btnClaimWA && btnClaimTG) {
        const pesan = encodeURIComponent(`Halo Admin, saya (${s?.userId||'-'}) memenangkan hadiah Mystery Box sebesar ${formatRupiah(prize)} di BELEGENDBET. Mohon proses klaimnya, terima kasih.`);
        btnClaimWA.href = `https://klikblg.com/wa-blb?text=${pesan}`;
        btnClaimTG.href = `https://t.me/asupanfreebet?text=${pesan}`;
      }
      const m=document.getElementById('modalPrize');
      m.classList.remove('hidden'); m.classList.add('flex');
      document.body.style.overflow='hidden';
      // Setelah claim, set flag agar tidak bisa main lagi walau refresh
      setClaimed(s?.kupon);
    }

    // Disable semua tombol dan grid setelah hadiah dicatat
    function disableGame() {
      setBoxesDisabled(true);
      hasSpun = true; // Set flag hasSpun untuk mencegah spin ulang
      btnSpin.disabled = true;
      btnSpin.classList.add('disabled');
      btnSpin.textContent = 'ğŸš« SUDAH DIGUNAKAN';
    }
    function closeModal(){
      const m=document.getElementById('modalPrize');
      m.classList.add('hidden'); m.classList.remove('flex');
      document.body.style.overflow='';
    }
    document.getElementById('btnCloseModal')?.addEventListener('click', closeModal);
    document.getElementById('btnCloseModal2')?.addEventListener('click', closeModal);

    // Klik kotak â†’ ambil hadiah dari API
    grid.addEventListener('click', e=>{
      const el=e.target.closest('button');
      if(!el || spinning || chosen) return;
      
      // PLAY WHOOSH SOUND UNTUK PILIH BOX
      playWhoosh();
      
      chosen=true; el.classList.add('picked'); setTimeout(()=>el.classList.remove('picked'),900);
      Array.from(grid.children).forEach(b=> b.classList.add('disabled'));
      // Ambil hadiah dari API, bukan random di client
      const resultText = document.getElementById('resultText');
      if (!s?.userId || !s?.kupon) {
        resultText.textContent = 'Session tidak valid. Silakan login ulang.';
        console.error('Session tidak valid', s);
        disableGame();
        return;
      }
      if (isClaimed(s.kupon)) {
        resultText.textContent = 'Kupon sudah pernah dipakai!';
        disableGame();
        return;
      }
  const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
  const url = `${apiUrl}?action=catat&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`;
      console.log('Kirim ke API:', url);
      fetch(url)
        .then(async res => {
          let data;
          try { data = await res.json(); } catch(e) { data = {success:false, msg:'Response bukan JSON'}; }
          console.log('Response API:', data);
          if (data.success) {
            openModalWithPrize(Number(data.hadiah));
            resultText.textContent = `Selamat ${s.userId}ğŸ‰ Bosku mendapatkan ${formatRupiah(Number(data.hadiah))}. Claim segera.`;
            disableGame();
            setClaimed(s.kupon);
          } else {
            resultText.textContent = `Gagal mencatat hadiah: ${data.msg || 'Error'}`;
            disableGame();
          }
        })
        .catch((err) => {
          resultText.textContent = 'Gagal menghubungi server. Coba lagi.';
          console.error('Fetch error:', err);
          disableGame();
        });
      if(btnSpin) btnSpin.textContent='ğŸ² SPIN BOX';
    });
    
    /* ==== SISTEM AUDIO - 3 SUARA ==== */
    let audioCtx;
    let tractorSound = null;
    let isTractorPlaying = false;
    
    function getCtx(){ 
      if(!audioCtx){ 
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
          console.log('Audio context created, state:', audioCtx.state);
        } catch (e) {
          console.error('Failed to create audio context:', e);
          return null;
        }
      } 
      if(audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          console.log('Audio context resumed, state:', audioCtx.state);
        }).catch(e => {
          console.error('Failed to resume audio context:', e);
        });
      }
      return audioCtx; 
    }
    
    // Initialize audio context on first user interaction
    let audioInitialized = false;
    function initAudioOnInteraction() {
      if (audioInitialized) return;
      audioInitialized = true;
      try { 
        getCtx(); 
        console.log('Audio initialized on user interaction');
      } catch(e) {
        console.error('Audio initialization failed:', e);
      }
    }
    
    window.addEventListener('pointerdown', initAudioOnInteraction, {once:true, passive:true});
    window.addEventListener('click', initAudioOnInteraction, {once:true, passive:true});
    window.addEventListener('touchstart', initAudioOnInteraction, {once:true, passive:true});
    
    // 1. SUARA JACKPOT REEL SPINNING KEREN untuk SPIN BOX
    function createJackpotReelSound() {
      try {
        const ctx = getCtx();
        if (!ctx) return null;
        
        // Buat oscillator untuk suara jackpot reel spinning yang mendebarkan
        const osc1 = ctx.createOscillator(); // Main reel spinning
        const osc2 = ctx.createOscillator(); // Mechanical whirring
        const osc3 = ctx.createOscillator(); // Metallic resonance
        const osc4 = ctx.createOscillator(); // High frequency sparkle
        
        // Frekuensi untuk suara jackpot reel yang realistis
        osc1.type = 'sawtooth';
        osc1.frequency.value = 120; // Bass spinning utama
        
        osc2.type = 'square';
        osc2.frequency.value = 80; // Mechanical whirring
        
        osc3.type = 'triangle';
        osc3.frequency.value = 240; // Metallic resonance
        
        osc4.type = 'sine';
        osc4.frequency.value = 1200; // High sparkle untuk excitement
        
        // Gain untuk masing-masing komponen reel
        const gain1 = ctx.createGain();
        const gain2 = ctx.createGain();
        const gain3 = ctx.createGain();
        const gain4 = ctx.createGain();
        const masterGain = ctx.createGain();
        
        gain1.gain.value = 0.6; // Main reel
        gain2.gain.value = 0.4; // Mechanical
        gain3.gain.value = 0.3; // Metallic
        gain4.gain.value = 0.2; // Sparkle
        masterGain.gain.value = 0;
        
        // Low-pass filter untuk suara reel yang smooth tapi powerful
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 800; // Sweet spot untuk reel sound
        filter.Q.value = 3; // Resonance sedang untuk warmth
        
        // Modulation untuk efek reel berputar
        const lfo = ctx.createOscillator();
        lfo.type = 'sine';
        lfo.frequency.value = 6; // 6 Hz modulation untuk reel effect
        
        const lfoGain = ctx.createGain();
        lfoGain.gain.value = 50; // Modulation depth
        
        // Reverb untuk efek ruang casino
        const delay = ctx.createDelay();
        delay.delayTime.value = 0.12;
        const delayGain = ctx.createGain();
        delayGain.gain.value = 0.2;
        
        // Connection dengan LFO modulation
        lfo.connect(lfoGain);
        lfoGain.connect(osc1.frequency); // Modulate main reel
        lfoGain.connect(osc2.frequency); // Modulate mechanical
        
        osc1.connect(gain1);
        osc2.connect(gain2);
        osc3.connect(gain3);
        osc4.connect(gain4);
        
        gain1.connect(filter);
        gain2.connect(filter);
        gain3.connect(filter);
        gain4.connect(filter);
        
        filter.connect(masterGain);
        filter.connect(delay);
        delay.connect(delayGain);
        delayGain.connect(masterGain);
        
        masterGain.connect(ctx.destination);
        
        return { 
          osc1: osc1, 
          osc2: osc2, 
          osc3: osc3,
          osc4: osc4,
          lfo: lfo,
          gain: masterGain, 
          filter: filter,
          gain1: gain1,
          gain2: gain2,
          gain3: gain3,
          gain4: gain4,
          lfoGain: lfoGain,
          delay: delay,
          delayGain: delayGain
        };
      } catch (e) {
        console.error('Error creating jackpot reel sound:', e);
        return null;
      }
    }
    
    function startJackpotReelSound() {
      if (isTractorPlaying) return;
      
      try {
        const ctx = getCtx();
        console.log('Starting JACKPOT REEL SPINNING sound for mystery box...');
        
        if (ctx.state === 'suspended') {
          ctx.resume();
        }
        
        isTractorPlaying = true;
        tractorSound = createJackpotReelSound();
        
        if (tractorSound) {
          // Start semua oscillators dan LFO
          tractorSound.osc1.start();
          tractorSound.osc2.start();
          tractorSound.osc3.start();
          tractorSound.osc4.start();
          tractorSound.lfo.start(); // Start LFO untuk modulation
          
          const currentTime = ctx.currentTime;
          
          // Build-up yang mendebarkan seperti jackpot reel
          tractorSound.gain.gain.setValueAtTime(0, currentTime);
          tractorSound.gain.gain.exponentialRampToValueAtTime(0.3, currentTime + 0.2); // Slow start
          tractorSound.gain.gain.exponentialRampToValueAtTime(0.8, currentTime + 1.0); // Build up
          tractorSound.gain.gain.exponentialRampToValueAtTime(1.0, currentTime + 2.0); // Peak excitement
          
          // Dynamic frequency modulation untuk reel spinning effect
          let reelInterval;
          let spinIntensity = 1.0;
          
          const modulateReelSpin = () => {
            if (!isTractorPlaying || !tractorSound) {
              if (reelInterval) clearInterval(reelInterval);
              return;
            }
            
            // Simulate accelerating reel spin
            const time = ctx.currentTime;
            spinIntensity = Math.min(spinIntensity + 0.05, 2.0); // Gradually increase intensity
            
            // Main reel frequency dengan acceleration
            const baseFreq1 = 100 + (spinIntensity * 40); // 100-180 Hz
            const baseFreq2 = 70 + (spinIntensity * 30);  // 70-130 Hz
            const baseFreq3 = 200 + (spinIntensity * 80); // 200-360 Hz
            
            // Sparkle frequency yang naik untuk excitement
            const sparkleFreq = 800 + (spinIntensity * 600); // 800-2000 Hz
            
            tractorSound.osc1.frequency.setValueAtTime(baseFreq1, time);
            tractorSound.osc2.frequency.setValueAtTime(baseFreq2, time);
            tractorSound.osc3.frequency.setValueAtTime(baseFreq3, time);
            tractorSound.osc4.frequency.setValueAtTime(sparkleFreq, time);
            
            // Filter sweep untuk dynamic sound
            const filterFreq = 600 + (spinIntensity * 400); // 600-1400 Hz
            tractorSound.filter.frequency.setValueAtTime(filterFreq, time);
            
            // LFO speed increase untuk faster reel effect
            const lfoSpeed = 4 + (spinIntensity * 6); // 4-16 Hz
            tractorSound.lfo.frequency.setValueAtTime(lfoSpeed, time);
            
            // Volume pulsing untuk excitement
            const baseVolume = 0.7 + (Math.sin(time * 3) * 0.2); // Subtle pulsing
            tractorSound.gain.gain.setValueAtTime(baseVolume * spinIntensity, time);
          };
          
          modulateReelSpin();
          reelInterval = setInterval(modulateReelSpin, 100); // Update setiap 100ms
          tractorSound.reelInterval = reelInterval;
        }
      } catch (e) {
        console.error('Error starting jackpot reel sound:', e);
        isTractorPlaying = false;
      }
    }
    
    function stopJackpotReelSound() {
      if (!isTractorPlaying || !tractorSound) return;
      
      try {
        console.log('Stopping JACKPOT REEL spinning with dramatic slowdown...');
        const ctx = getCtx();
        
        if (tractorSound.reelInterval) {
          clearInterval(tractorSound.reelInterval);
        }
        
        // Dramatic reel slowdown seperti jackpot machine berhenti
        const currentTime = ctx.currentTime;
        
        // Phase 1: Quick deceleration (0.0-0.4s)
        tractorSound.gain.gain.setValueAtTime(tractorSound.gain.gain.value, currentTime);
        tractorSound.gain.gain.exponentialRampToValueAtTime(0.6, currentTime + 0.2);
        
        // Slow down reel frequencies
        tractorSound.osc1.frequency.exponentialRampToValueAtTime(80, currentTime + 0.4);
        tractorSound.osc2.frequency.exponentialRampToValueAtTime(50, currentTime + 0.4);
        tractorSound.osc3.frequency.exponentialRampToValueAtTime(150, currentTime + 0.4);
        
        // Phase 2: Medium slowdown (0.4-0.8s)
        tractorSound.gain.gain.exponentialRampToValueAtTime(0.4, currentTime + 0.5);
        tractorSound.osc1.frequency.exponentialRampToValueAtTime(60, currentTime + 0.8);
        tractorSound.osc2.frequency.exponentialRampToValueAtTime(35, currentTime + 0.8);
        
        // Phase 3: Final slow clicks seperti reel berhenti (0.8-1.2s)
        tractorSound.gain.gain.exponentialRampToValueAtTime(0.2, currentTime + 0.9);
        tractorSound.osc1.frequency.exponentialRampToValueAtTime(40, currentTime + 1.1);
        tractorSound.osc2.frequency.exponentialRampToValueAtTime(25, currentTime + 1.1);
        
        // Final fade dengan sparkle yang hilang perlahan
        tractorSound.osc4.frequency.exponentialRampToValueAtTime(600, currentTime + 1.0);
        tractorSound.gain.gain.exponentialRampToValueAtTime(0.01, currentTime + 1.3);
        
        // LFO slowdown untuk realistic reel stop
        tractorSound.lfo.frequency.exponentialRampToValueAtTime(1, currentTime + 0.8);
        tractorSound.lfo.frequency.exponentialRampToValueAtTime(0.1, currentTime + 1.2);
        
        setTimeout(() => {
          if (tractorSound) {
            try {
              tractorSound.osc1.stop();
              tractorSound.osc2.stop();
              tractorSound.osc3.stop();
              tractorSound.osc4.stop();
              tractorSound.lfo.stop();
            } catch (e) {
              console.warn('Audio oscillators already stopped:', e);
            }
            tractorSound = null;
          }
          isTractorPlaying = false;
        }, 1350);
      } catch (e) {
        console.error('Error stopping jackpot reel sound:', e);
        isTractorPlaying = false;
        tractorSound = null;
      }
    }
    
    // 2. SUARA WHOOSH untuk PILIH BOX (seperti di gedorpintu)
    function playWhoosh(){
      try {
        const ctx = getCtx(); 
        const dur = 0.45;
        const bufferSize = ctx.sampleRate * dur;
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        
        for(let i=0;i<bufferSize;i++) data[i] = Math.random()*2-1;
        
        const src = ctx.createBufferSource(); 
        src.buffer = buffer;
        
        const filter = ctx.createBiquadFilter(); 
        filter.type='lowpass'; 
        filter.frequency.setValueAtTime(400, ctx.currentTime); 
        filter.frequency.exponentialRampToValueAtTime(8000, ctx.currentTime + dur);
        
        const gain = ctx.createGain(); 
        gain.gain.setValueAtTime(0.0001, ctx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(.6, ctx.currentTime+0.05); 
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
        
        src.connect(filter).connect(gain).connect(ctx.destination); 
        src.start();
        
        console.log('Playing whoosh sound for box pick');
      } catch (e) {
        console.warn('Error playing whoosh sound:', e);
      }
    }
    
    // 3. SUARA CHA-CHING untuk HADIAH (seperti di gedorpintu)
    function playChaChing(){
      try {
        const ctx = getCtx(); 
        const t0 = ctx.currentTime + 0.02;
        
        const o1 = ctx.createOscillator(); 
        o1.type='triangle'; 
        const g1 = ctx.createGain(); 
        g1.gain.setValueAtTime(0.0001, t0); 
        g1.gain.exponentialRampToValueAtTime(0.7, t0+0.02); 
        g1.gain.exponentialRampToValueAtTime(0.0001, t0+0.7); 
        o1.frequency.setValueAtTime(1100, t0); 
        o1.frequency.exponentialRampToValueAtTime(1600, t0+0.08);
        
        const o2 = ctx.createOscillator(); 
        o2.type='square';   
        const g2 = ctx.createGain(); 
        g2.gain.setValueAtTime(0.0001, t0); 
        g2.gain.exponentialRampToValueAtTime(0.35, t0+0.02); 
        g2.gain.exponentialRampToValueAtTime(0.0001, t0+0.55); 
        o2.frequency.setValueAtTime(660, t0);  
        o2.frequency.exponentialRampToValueAtTime(990, t0+0.06);
        
        const nDur=0.09; 
        const b = ctx.createBuffer(1, ctx.sampleRate*nDur, ctx.sampleRate); 
        const d=b.getChannelData(0); 
        for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
        
        const n = ctx.createBufferSource(); 
        n.buffer=b; 
        const ng=ctx.createGain(); 
        ng.gain.setValueAtTime(0.4, t0); 
        ng.gain.exponentialRampToValueAtTime(0.0001, t0+nDur);
        
        o1.connect(g1).connect(ctx.destination); 
        o2.connect(g2).connect(ctx.destination); 
        n.connect(ng).connect(ctx.destination);
        
        o1.start(t0); 
        o2.start(t0+0.02); 
        n.start(t0); 
        o1.stop(t0+0.7); 
        o2.stop(t0+0.55); 
        n.stop(t0+nDur);
        
        console.log('Playing cha-ching sound for prize');
      } catch (e) {
        console.warn('Error playing cha-ching sound:', e);
      }
    }
    
    // Cleanup suara saat halaman ditutup atau kehilangan focus
    window.addEventListener('beforeunload', () => {
      stopBikeBellSound();
    });
    
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopBikeBellSound();
      }
    });
  })();
  </script>
</body>
</html>
