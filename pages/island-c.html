<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pulau C - Wheel of Fortune</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="../css/main.css">
<link rel="stylesheet" href="../css/neon-theme.css">
<link rel="stylesheet" href="../css/animations.css">
<link rel="stylesheet" href="../css/responsive.css">
</head>
<body class="flex flex-col min-h-screen overflow-x-hidden bg-wheel">

<!-- HEADER -->
<header class="header-full fixed z-50 p-0 m-0">
<nav class="w-full bg-gradient-to-r from-slate-900 via-indigo-900 to-purple-900 shadow-md">
<div class="w-full flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
<a href="../index.html" class="text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">BELEGENDBET</a>
<button id="btnBackToMap" class="hover:text-white px-5 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-semibold shadow-lg transition">âŸµ Kembali Map</button>
</div>
</nav>
</header>
<div class="h-16"></div>

<!-- MAIN CONTENT -->
<main class="flex-grow flex flex-col items-center justify-center w-full relative z-10 island-page">
<div class="bg-wheel">
<div class="shine-effect-gold"></div>
</div>

<div class="text-center mb-8">
<h1 class="neon-title text-green-300">WHEEL OF FORTUNE</h1>
<p class="text-xl text-white mb-4">Putar roda keberuntungan dan menangkan hadiah!</p>
<div id="userInfo" class="text-lg text-cyan-300">
<span>User: <span id="tbUser">-</span></span>
<span class="mx-4">â€¢</span>
<span>Kupon: <span id="tbKupon">-</span></span>
</div>
</div>

<!-- WHEEL OF FORTUNE -->
<div class="wheel-container relative mb-8">
<div class="relative">
<!-- Wheel -->
<div id="wheel" class="w-80 h-80 rounded-full border-8 border-yellow-400 relative overflow-hidden shadow-2xl">
<svg class="w-full h-full" viewBox="0 0 400 400">
<g id="wheelSegments">
<!-- Segments will be generated by JavaScript -->
</g>
</svg>
</div>

<!-- Pointer -->
<div class="wheel-pointer absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2 z-10">
<div class="w-0 h-0 border-l-4 border-r-4 border-b-8 border-l-transparent border-r-transparent border-b-yellow-400"></div>
</div>
</div>

<div class="text-center">
<button id="btnWheelSpin" class="neon-btn-green btn-primary text-xl px-12 py-4 mb-4">
ðŸŽ¯ SPIN WHEEL
</button>
<div id="wheelResult" class="text-2xl font-bold text-yellow-300 min-h-[2rem]"></div>
</div>
</div>

<!-- PRIZE TABLE -->
<div class="bg-gray-800 rounded-2xl p-6 max-w-md w-full border-2 border-green-400">
<h3 class="text-xl font-bold text-green-300 mb-4 text-center">Segmen Roda</h3>
<div class="grid grid-cols-2 gap-2 text-white text-sm">
<div class="flex justify-between items-center p-2 bg-red-600 rounded">
<span>Rp 500</span>
</div>
<div class="flex justify-between items-center p-2 bg-teal-600 rounded">
<span>Rp 1.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-blue-600 rounded">
<span>Rp 2.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-green-600 rounded">
<span>Rp 5.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-yellow-600 rounded">
<span>Rp 10.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-pink-600 rounded">
<span>Rp 15.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-indigo-600 rounded">
<span>Rp 25.000</span>
</div>
<div class="flex justify-between items-center p-2 bg-yellow-400 text-black rounded font-bold">
<span>JACKPOT!</span>
</div>
</div>
</div>
</main>

<!-- PRIZE MODAL -->
<div id="modalWheelPrize" class="fixed inset-0 hidden items-center justify-center z-50 modal-bg">
<div class="relative bg-[#1b1e2a] rounded-2xl shadow-2xl border border-white/10 w-[90%] max-w-xl p-6">
<h3 class="text-center text-2xl font-extrabold text-yellow-300 mb-4">Hasil Wheel of Fortune</h3>
<div class="text-center mb-4">
<div id="winningSegment" class="text-4xl mb-4 font-bold text-green-300"></div>
<div id="wheelResultText" class="text-lg font-bold text-yellow-300"></div>
</div>
<div class="flex justify-center mt-5">
<button id="btnCloseWheelModal" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow">Tutup</button>
</div>
<button id="btnCloseWheelModal2" class="absolute -top-3 -right-3 bg-red-500 text-white w-9 h-9 rounded-full font-bold shadow">âœ•</button>
</div>
</div>

<!-- FOOTER -->
<footer class="mt-8 py-5 text-center text-gray-400 text-sm border-t border-slate-700 bg-slate-900 z-50 relative">
<p>&copy; 2024 BELEGENDBET. Hak Cipta Dilindungi Undang-Undang.</p>
</footer>

<script type="module">
import { $, loadSession, formatRupiah, showModal, hideModal } from '../js/utils.js';
import rewardManager from '../js/rewards.js';
import { submitPrizeData, logActivity } from '../js/api.js';

class WheelOfFortuneGame {
  constructor() {
    this.isSpinning = false;
    this.rewardSystem = rewardManager.getRewardSystem('C');
    this.segments = this.rewardSystem.getSegments();
    this.init();
  }

  init() {
    this.loadUserInfo();
    this.setupEventListeners();
    this.renderWheel();
  }

  loadUserInfo() {
    const session = loadSession();
    if (session) {
      $('#tbUser').textContent = session.userId || '-';
      $('#tbKupon').textContent = session.kupon || '-';
    }
  }

  setupEventListeners() {
    $('#btnWheelSpin').addEventListener('click', () => this.spin());
    $('#btnBackToMap').addEventListener('click', () => {
      window.location.href = '../index.html';
    });
    $('#btnCloseWheelModal').addEventListener('click', () => this.closeModal());
    $('#btnCloseWheelModal2').addEventListener('click', () => this.closeModal());
  }

  renderWheel() {
    const segmentsGroup = $('#wheelSegments');
    const segmentAngle = 360 / this.segments.length;
    
    this.segments.forEach((segment, index) => {
      const startAngle = index * segmentAngle;
      const endAngle = (index + 1) * segmentAngle;
      
      const x1 = 200 + 180 * Math.cos((startAngle - 90) * Math.PI / 180);
      const y1 = 200 + 180 * Math.sin((startAngle - 90) * Math.PI / 180);
      const x2 = 200 + 180 * Math.cos((endAngle - 90) * Math.PI / 180);
      const y2 = 200 + 180 * Math.sin((endAngle - 90) * Math.PI / 180);
      
      const largeArcFlag = segmentAngle > 180 ? 1 : 0;
      
      const pathData = [
        `M 200 200`,
        `L ${x1} ${y1}`,
        `A 180 180 0 ${largeArcFlag} 1 ${x2} ${y2}`,
        `Z`
      ].join(' ');
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', pathData);
      path.setAttribute('fill', segment.color);
      path.setAttribute('stroke', '#fff');
      path.setAttribute('stroke-width', '2');
      
      const textAngle = startAngle + segmentAngle / 2;
      const textX = 200 + 120 * Math.cos((textAngle - 90) * Math.PI / 180);
      const textY = 200 + 120 * Math.sin((textAngle - 90) * Math.PI / 180);
      
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', textX);
      text.setAttribute('y', textY);
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('dominant-baseline', 'middle');
      text.setAttribute('fill', segment.label === 'JACKPOT!' ? '#000' : '#fff');
      text.setAttribute('font-size', '14');
      text.setAttribute('font-weight', 'bold');
      text.textContent = segment.label;
      
      segmentsGroup.appendChild(path);
      segmentsGroup.appendChild(text);
    });
  }

  async spin() {
    if (this.isSpinning) return;

    this.isSpinning = true;
    const btnSpin = $('#btnWheelSpin');
    const resultDiv = $('#wheelResult');
    const wheel = $('#wheel');

    btnSpin.disabled = true;
    btnSpin.textContent = 'âš¡ SPINNING...';
    resultDiv.textContent = '';

    // Get result
    const result = this.rewardSystem.generatePrize();
    
    // Add spinning animation
    wheel.classList.add('wheel-spinning');
    wheel.style.transform = `rotate(${result.rotation}deg)`;

    // Wait for animation to complete
    setTimeout(async () => {
      // Show result
      const session = loadSession();
      const formattedResult = this.rewardSystem.formatPrizeResult(result, session?.userId);
      
      resultDiv.textContent = formattedResult.message;
      resultDiv.className = 'text-2xl font-bold text-yellow-300';

      // Submit data
      if (session) {
        await submitPrizeData(session.userId, session.kupon, 'C', 'wheel_of_fortune', result.segment.value);
        await logActivity(session.userId, 'prize_won', { island: 'C', prize: result.segment.value, segment: result.segment.label });
      }

      // Show modal
      setTimeout(() => {
        this.showPrizeModal(formattedResult);
      }, 1000);

      // Reset button
      btnSpin.disabled = false;
      btnSpin.textContent = 'ðŸŽ¯ SPIN WHEEL';
      this.isSpinning = false;

      // Remove animation class
      wheel.classList.remove('wheel-spinning');
    }, 3000);
  }

  showPrizeModal(result) {
    $('#winningSegment').textContent = result.segment.label;
    $('#wheelResultText').textContent = result.message;
    showModal('#modalWheelPrize');
  }

  closeModal() {
    hideModal('#modalWheelPrize');
  }
}

// Initialize game when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new WheelOfFortuneGame();
});
</script>

</body>
</html>
