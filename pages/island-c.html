<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pulau C - GEDOR PINTU HOKI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/neon-theme.css">
  <link rel="stylesheet" href="../css/animations.css">
  <link rel="stylesheet" href="../css/responsive.css">
</head>
<body class="door-knocking-body">

<!-- HEADER -->
<header class="header-full fixed z-50 p-0 m-0">
<nav class="w-full bg-gradient-to-r from-slate-900 via-indigo-900 to-purple-900 shadow-md">
<div class="w-full flex items-center justify-between gap-3 px-3 sm:px-6 py-3">
<a href="../index.html" class="text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">BELEGENDBET</a>
<button id="btnBackToMap" class="hover:text-white px-5 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-semibold shadow-lg transition">âŸµ Kembali Map</button>
</div>
</nav>
</header>

<!-- USER INFO -->
<div class="fixed top-20 right-4 z-40 bg-black/50 backdrop-blur-sm rounded-lg p-3 text-sm">
<div id="userInfo" class="text-cyan-300">
<span>User: <span id="tbUser">-</span></span>
<span class="mx-2">â€¢</span>
<span>Kupon: <span id="tbKupon">-</span></span>
</div>
</div>

  <canvas id="bgCanvas"></canvas>
  <div class="bg-vignette"></div>

  <div class="container">
    <section class="hero" id="hadiah">
      <div class="eyebrow">Event Promosi Eksklusif</div>
      <h1 class="title" aria-label="GEDOR PINTU HOKI">
        <span class="neon-1">GEDOR</span> <span class="neon-2">PINTU HOKI</span>
      </h1>
      <p class="subtitle">Pilih pintumu. Rebut hadiahnya. Sensasi luxury, speed & high energy dalam mode neon futuristik.</p>
    </section>

    <section id="pintu" aria-label="Galeri Pintu" class="doors">
      <button class="door door-pink" aria-label="Pintu 1">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
      <button class="door door-pink" aria-label="Pintu 2">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
      <button class="door door-pink" aria-label="Pintu 3">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
      <button class="door door-pink" aria-label="Pintu 4">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
      <button class="door door-pink" aria-label="Pintu 5">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
      <button class="door door-pink" aria-label="Pintu 6">
        <div class="frame"><div class="edge"></div>
          <div class="leaf"><span class="knob"></span><span class="side"></span></div>
          <div class="inside"><div class="prize-icon" aria-hidden="true"></div></div>
        </div>
      </button>
    </section>

    <div class="cta-bottom">
      <a class="cta" href="#pintu" role="button" aria-label="Spin Door Prize">
        <span class="pulse" aria-hidden="true"></span>
        ðŸŽ° SPIN DOOR PRIZE
      </a>
    </div>

    <div class="palette" aria-hidden="true">
      <span class="sw" style="color:#27b0ff"></span>
      <span class="sw" style="color:#ff2ea6"></span>
      <span class="sw" style="color:#ffc94a"></span>
      <span class="sw" style="color:#39ff7f"></span>
      <span class="sw" style="color:#ff3b3b"></span>
      <span class="sw" style="color:#00e7ff"></span>
    </div>
  </div>

  <footer class="legal-bottom">Â© 2024 BELEGENDBET. Hak Cipta Dilindungi Undang-Undang.</footer>

  <div id="winModal" class="modal" aria-hidden="true" role="dialog" aria-label="Hadiah">
    <div class="modal-card">
      <div class="eyebrow">Selamat!</div>
      <h2>Anda Mendapat Hadiah</h2>
      <div id="amount" class="amount">Rp 0</div>
      <div class="actions">
        <button class="btn primary" id="claimBtn">CLAIM HADIAH</button>
        <button class="btn" id="playAgainBtn">MAIN LAGI</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Hampir! Coba pintu lain.</div>

  <script type="module">
  import { $, loadSession, formatRupiah } from '../js/utils.js';
  import { submitPrizeData, logActivity } from '../js/api.js';

  class DoorKnockingGame {
    constructor() {
      this.doors = [...document.querySelectorAll('.door')];
      this.toast = document.getElementById('toast');
      this.modal = document.getElementById('winModal');
      this.amountEl = document.getElementById('amount');
      this.claimBtn = document.getElementById('claimBtn');
      this.playAgainBtn = document.getElementById('playAgainBtn');
      this.ctaSpin = document.querySelector('.cta');
      this.selectEnabled = false;
      this.spinActive = false;
      this.gameLocked = false;
      
      this.smallWins = ["Rp 2.000","Rp 4.000","Rp 6.000"];
      this.showcaseBig = ["Rp 50.000","Rp 100.000","Rp 1.000.000"];
      
      this.init();
    }

    init() {
      this.loadUserInfo();
      this.setupEventListeners();
      this.initializeBackground();
    }

    loadUserInfo() {
      const session = loadSession();
      if (session) {
        $('#tbUser').textContent = session.userId || '-';
        $('#tbKupon').textContent = session.kupon || '-';
      }
    }

    setupEventListeners() {
      $('#btnBackToMap').addEventListener('click', () => {
        window.location.href = '../index.html';
      });

      this.doors.forEach((door, idx) => {
        door.addEventListener('click', () => {
          if (!this.selectEnabled || this.gameLocked) {
            if (!this.spinActive) this.showToast('Tekan SPIN dulu');
            return;
          }
          this.handleDoor(idx, door);
        });
      });

      this.ctaSpin.addEventListener('click', (e) => {
        e.preventDefault();
        this.startSpin();
      });

      this.claimBtn.onclick = () => {
        this.modal.classList.remove('show');
        this.showToast('Hadiah diclaim!');
        this.resetGame();
      };

      this.playAgainBtn.onclick = () => {
        this.modal.classList.remove('show');
        this.resetGame();
      };

      this.modal.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.modal.classList.remove('show');
          this.resetGame();
        }
      });
    }

    initializeBackground() {
      const DPR = Math.min(2, window.devicePixelRatio || 1);
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d');
      let W, H;
      
      function resize() {
        W = canvas.width = Math.floor(innerWidth * DPR);
        H = canvas.height = Math.floor(innerHeight * DPR);
      }
      resize();
      addEventListener('resize', resize);
      
      const rnd = (min, max) => Math.random() * (max - min) + min;
      const dust = Array.from({length: 90}, () => ({
        x: Math.random() * W,
        y: Math.random() * H,
        r: rnd(0.5, 1.6) * DPR,
        a: rnd(0.15, 0.45),
        vx: rnd(-0.1, 0.1) * DPR,
        vy: rnd(-0.05, 0.05) * DPR
      }));
      
      function loop() {
        ctx.clearRect(0, 0, W, H);
        for (const p of dust) {
          p.x += p.vx;
          p.y += p.vy;
          if (p.x < 0) p.x = W;
          if (p.x > W) p.x = 0;
          if (p.y < 0) p.y = H;
          if (p.y > H) p.y = 0;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(210,80%,70%,${p.a})`;
          ctx.fill();
        }
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    }

    startSpin() {
      if (this.spinActive || this.gameLocked) return;
      this.spinActive = true;
      this.selectEnabled = false;
      let idx = -1, elapsed = 0;
      const total = 1700, step = 120;
      
      const timer = setInterval(() => {
        this.doors.forEach(d => d.classList.remove('highlight'));
        idx = (idx + 1) % this.doors.length;
        this.doors[idx].classList.add('highlight');
        elapsed += step;
        if (elapsed >= total) {
          clearInterval(timer);
          this.doors.forEach(d => d.classList.remove('highlight'));
          this.spinActive = false;
          this.selectEnabled = true;
          this.showToast('Pilih 1 pintu');
        }
      }, step);
    }

    async handleDoor(idx, door) {
      if (this.gameLocked) return;
      this.gameLocked = true;
      this.selectEnabled = false;

      const selectedAmount = this.smallWins[Math.floor(Math.random() * this.smallWins.length)];

      this.playWhoosh(() => {
        this.doors.forEach((d, i) => {
          d.classList.add('open');

          const inside = d.querySelector('.inside');
          const icon = d.querySelector('.prize-icon');
          const leaf = d.querySelector('.leaf');

          inside.classList.add('portal');

          const prizeIconType = (i === idx) ? 'coin' : ((i % 2 === 0) ? 'diamond' : 'crown');
          const prizeLabelText = (i === idx) ? selectedAmount : this.showcaseBig[i % this.showcaseBig.length];
          icon.innerHTML = this.getPrizeSVG(prizeIconType) + `<div class="prize-label">${prizeLabelText}</div>`;

          const hide = () => d.classList.add('leaf-hidden');
          const onEnd = (e) => {
            if (e.propertyName === 'transform') {
              hide();
              leaf.removeEventListener('transitionend', onEnd);
            }
          };
          leaf.addEventListener('transitionend', onEnd);
          setTimeout(hide, 700);
        });

        setTimeout(async () => {
          this.playChaChing();
          this.revealWin(selectedAmount);
          
          const session = loadSession();
          if (session) {
            const prizeValue = parseInt(selectedAmount.replace(/[^\d]/g, ''));
            await submitPrizeData(session.userId, session.kupon, 'C', 'door_knocking', prizeValue);
            await logActivity(session.userId, 'prize_won', { island: 'C', prize: prizeValue, door: idx + 1 });
          }
        }, 1100);
      });
    }

    getPrizeSVG(type) {
      switch (type) {
        case 'diamond':
          return `<svg width="96" height="96" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-label="Diamond"><defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#9be9ff"/><stop offset="100%" stop-color="#49c9ff"/></linearGradient></defs><polygon points="12,32 32,12 64,12 84,32 48,84" fill="url(#g1)" stroke="#1aa3e6" stroke-width="3"/></svg>`;
        case 'crown':
          return `<svg width="96" height="96" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-label="Crown"><defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ffe88a"/><stop offset="100%" stop-color="#ffc94a"/></linearGradient></defs><path d="M10 70 L22 30 L40 55 L56 28 L74 55 L86 30 L96 70 Z" fill="url(#g2)" stroke="#d6a200" stroke-width="3"/></svg>`;
        case 'coin':
          return `<svg width="96" height="96" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-label="Coin"><defs><radialGradient id="g3" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#fff3a6"/><stop offset="100%" stop-color="#f2b705"/></radialGradient></defs><ellipse cx="48" cy="48" rx="34" ry="28" fill="url(#g3)" stroke="#b58100" stroke-width="3"/></svg>`;
        default:
          return `<svg width="96" height="96" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg" aria-label="Star"><polygon points="48,8 58,36 88,36 62,54 72,84 48,66 24,84 34,54 8,36 38,36" fill="#ffd24f" stroke="#b58100" stroke-width="3"/></svg>`;
      }
    }

    showToast(msg) {
      this.toast.textContent = msg;
      this.toast.classList.add('show');
      clearTimeout(this.showToast.t);
      this.showToast.t = setTimeout(() => this.toast.classList.remove('show'), 1500);
    }

    revealWin(amount) {
      this.amountEl.textContent = amount;
      this.modal.classList.add('show');
      this.modal.setAttribute('aria-hidden', 'false');
    }

    resetGame() {
      this.doors.forEach(d => {
        d.classList.remove('open', 'leaf-hidden');
        const ic = d.querySelector('.prize-icon');
        if (ic) ic.innerHTML = '';
        const inside = d.querySelector('.inside');
        if (inside) inside.classList.remove('portal');
        const leaf = d.querySelector('.leaf');
        if (leaf) leaf.style.visibility = '';
      });
      this.gameLocked = false;
      this.selectEnabled = false;
      this.spinActive = false;
    }

    getCtx() {
      if (!this.audioCtx) {
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
      return this.audioCtx;
    }

    playWhoosh(done) {
      const ctx = this.getCtx();
      const dur = 0.45;
      const bufferSize = ctx.sampleRate * dur;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
      
      const src = ctx.createBufferSource();
      src.buffer = buffer;
      const filter = ctx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(400, ctx.currentTime);
      filter.frequency.exponentialRampToValueAtTime(8000, ctx.currentTime + dur);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(.6, ctx.currentTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
      
      src.connect(filter).connect(gain).connect(ctx.destination);
      src.start();
      src.onended = () => done && done();
    }

    playChaChing() {
      const ctx = this.getCtx();
      const t0 = ctx.currentTime + 0.02;
      
      const o1 = ctx.createOscillator();
      o1.type = 'triangle';
      const g1 = ctx.createGain();
      g1.gain.setValueAtTime(0.0001, t0);
      g1.gain.exponentialRampToValueAtTime(0.7, t0 + 0.02);
      g1.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.7);
      o1.frequency.setValueAtTime(1100, t0);
      o1.frequency.exponentialRampToValueAtTime(1600, t0 + 0.08);
      
      const o2 = ctx.createOscillator();
      o2.type = 'square';
      const g2 = ctx.createGain();
      g2.gain.setValueAtTime(0.0001, t0);
      g2.gain.exponentialRampToValueAtTime(0.35, t0 + 0.02);
      g2.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.55);
      o2.frequency.setValueAtTime(660, t0);
      o2.frequency.exponentialRampToValueAtTime(990, t0 + 0.06);
      
      const nDur = 0.09;
      const b = ctx.createBuffer(1, ctx.sampleRate * nDur, ctx.sampleRate);
      const d = b.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
      
      const n = ctx.createBufferSource();
      n.buffer = b;
      const ng = ctx.createGain();
      ng.gain.setValueAtTime(0.4, t0);
      ng.gain.exponentialRampToValueAtTime(0.0001, t0 + nDur);
      
      o1.connect(g1).connect(ctx.destination);
      o2.connect(g2).connect(ctx.destination);
      n.connect(ng).connect(ctx.destination);
      
      o1.start(t0);
      o2.start(t0 + 0.02);
      n.start(t0);
      o1.stop(t0 + 0.7);
      o2.stop(t0 + 0.55);
      n.stop(t0 + nDur);
    }
  }

  // Initialize game when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new DoorKnockingGame();
  });
  </script>
</body>
</html>
