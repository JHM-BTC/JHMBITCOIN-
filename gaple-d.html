<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#100525" />
<meta name="color-scheme" content="dark light" />
<title>DOOR PRIZE GO GAPLE â€” Super Glossy HD (Lite)</title>
<!-- Preconnect untuk Google Fonts (kurangi blocking) -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== PALET WARNA: SUPER GLOSSY HD ===== */
:root{
  --bg:#100525; --panel:#2a1a5e; --panel-2:#1c1044; --ink:#ffffff; --muted:#c0c8ff;
  --a:#ffd700; --b:#00c6ff; --c:#00ff7f; --success:#28a745;
  --glow-a:0 0 12px rgba(255,215,0,.7), 0 0 24px rgba(255,215,0,.4), 0 0 46px rgba(255,215,0,.25);
  --glow-b:0 0 12px rgba(0,198,255,.6), 0 0 24px rgba(0,198,255,.35), 0 0 46px rgba(0,198,255,.2);
  --radius:18px;
  /* === NEON HIJAU VARIABEL === */
  --neon:#39ff14; --neon2:#00ff88; --glow-neon: 0 0 14px rgba(57,255,20,.95), 0 0 26px rgba(57,255,20,.7), 0 0 48px rgba(57,255,20,.45), 0 0 72px rgba(57,255,20,.28);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 1200px at 10% 0%, #3a2a7b 0%, var(--bg) 42%, #08031a 100%);
  color:var(--ink);
  font-family:Roboto, system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
  letter-spacing:.2px;
  overflow-x:hidden;
  padding-top:58px; padding-bottom:36px
}

/* ===== HEADER ===== */
.site-header{position:fixed; inset:0 0 auto 0; height:48px; display:flex; align-items:center; justify-content:space-between; padding:0 14px 0 12px; z-index:20; background:linear-gradient(90deg, #4a3a8a 0%, #6a4ecf 45%, #8a5fff 100%); box-shadow:0 2px 10px rgba(0,0,0,.45); border-bottom:1px solid rgba(255,255,255,.12)}
.site-header .brand{font-family:Orbitron, sans-serif; font-weight:900; letter-spacing:1px; font-size:14px; background:linear-gradient(90deg, #fff2ac, #ffd700); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 6px rgba(255,215,0,.45);}
.home-btn{--pad:8px 14px; position:relative; display:inline-flex; align-items:center; gap:8px; padding:var(--pad); border-radius:12px; border:1px solid rgba(255,255,255,.28); background:linear-gradient(180deg,#ffea70,#ffd700); color:#3d2500; font-weight:800; font-family:Orbitron; letter-spacing:.5px; text-decoration:none; box-shadow:0 6px 16px rgba(0,0,0,.4), inset 0 1px 1px rgba(255,255,255,.45), inset 0 0 8px rgba(255,248,220,.28)}
.home-btn:hover{filter:brightness(1.08)}

/* ===== FOOTER ===== */
.site-footer{position:fixed; left:0; right:0; bottom:0; height:32px; z-index:18; display:flex; align-items:center; justify-content:center; padding:0 12px; background:linear-gradient(90deg,#1c1044 0%, #2a1a5e 50%, #3c2a8a 100%); border-top:1px solid rgba(255,255,255,.1); color:#e0e6ff; font-size:12px}
.site-footer p{margin:0; opacity:.9; letter-spacing:.2px}

.main-container{max-width:1200px; margin:8px auto 32px; padding:24px; position:relative; border-radius:var(--radius); background:linear-gradient(180deg, rgba(42,26,94,.9), rgba(28,16,68,.92)); box-shadow:0 8px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.1), var(--glow-gold); isolation:isolate; backdrop-filter: blur(4px); contain: content; content-visibility:auto;}
.main-container::before{content:""; position:absolute; inset:-2px; z-index:-1; border-radius:calc(var(--radius) + 2px); background:conic-gradient(from 0deg at 10% 10%, var(--b), var(--a), var(--c), var(--b)); filter:blur(10px) saturate(150%); opacity:.8; mask:linear-gradient(#000 0 0) exclude, linear-gradient(#000 0 0) content-box; padding:2px}

.title{margin:6px 6px 18px; text-align:center; font-family:Orbitron, Roboto, sans-serif; font-weight:900; font-size:clamp(24px, 5vw, 48px); letter-spacing:1px; background:linear-gradient(90deg, var(--a), #ffffff 50%, var(--b)); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 18px rgba(255,215,0,.55), 0 0 28px rgba(0,198,255,.5)}

/* ===== LAYOUT ===== */
.main-content{display:grid; grid-template-columns:1.7fr 1fr; gap:18px; align-items:start}
@media (max-width: 1024px){ .main-content{grid-template-columns:1fr} }

.panel, .left-panel{background:linear-gradient(160deg, var(--panel), var(--panel-2)); border-radius:16px; padding:16px; box-shadow:inset 0 1px 1px rgba(255,255,255,.12), 0 10px 20px rgba(0,0,0,.5); content-visibility:auto; contain:paint;}
.panel h3{margin:0 0 10px; font-family:Orbitron; font-size:1rem; letter-spacing:.8px; color:#f0f8ff; text-shadow:0 0 4px rgba(255,255,255,.18)}

/* ring hijau */
.panel, .left-panel{ position:relative; isolation:isolate; }
.panel{ box-shadow:inset 0 1px 1px rgba(255,255,255,.12), 0 10px 20px rgba(0,0,0,.5), var(--glow-neon); }
.left-panel{ box-shadow:inset 0 1px 1px rgba(255,255,255,.12), 0 10px 20px rgba(0,0,0,.5), var(--glow-neon); }
.panel::after, .left-panel::after{content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; padding:1.5px; background:linear-gradient(180deg, var(--neon), var(--neon2) 60%, var(--neon)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; filter: drop-shadow(0 0 12px rgba(57,255,20,.9)) drop-shadow(0 0 24px rgba(57,255,20,.65)) drop-shadow(0 0 46px rgba(57,255,20,.4)); opacity:.96; animation: neonPulse 2.8s ease-in-out infinite;}
@keyframes neonPulse{ 0%,100%{ opacity:.92 } 50%{ opacity:1 } }
@media (prefers-reduced-motion: reduce){ .panel::after, .left-panel::after{ animation:none } }

/* ===== MESIN PAPAN GAPLE ===== */
.board-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
.board-title{font-weight:800; letter-spacing:.7px; text-transform:uppercase; font-size:.95rem; color:#fff5e6}

.gaple-board{position:relative; overflow:hidden; border-radius:18px; height: clamp(360px, 68vw, 560px); margin:8px 0 14px; background: radial-gradient(140% 100% at 50% 0%, rgba(255,215,0,.12), transparent 60%), repeating-linear-gradient(0deg, #1a103f 0 6px, #150c35 6px 12px); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1), inset 0 0 70px rgba(0,0,0,.7); contain:paint; content-visibility:auto; contain-intrinsic-size: 520px;}
.gaple-board::after{content:""; position:absolute; inset:10px; border-radius:14px; z-index:0; background: radial-gradient(60% 60% at 50% 50%, rgba(255,255,255,.75) 0%, rgba(255,255,255,0) 40%), conic-gradient(from 0deg at 50% 50%, #ff0000 0%, #ff7f00 12%, #ffff00 25%, #00ff00 37%, #00ffff 50%, #0066ff 62%, #8a00ff 75%, #ff00ff 87%, #ff0000 100%), radial-gradient(120% 120% at 50% 50%, rgba(0,0,0,0) 60%, rgba(0,0,0,.6) 100%); filter: brightness(1.05) saturate(1.7) blur(6px); opacity:.95;}
.gaple-board .spinlight, .gaple-board .spinlight-ccw{position:absolute; inset:10px; border-radius:14px; z-index:0; pointer-events:none; mix-blend-mode: screen; filter: blur(12px) brightness(1.2) saturate(1.1);}
.gaple-board .spinlight{background: radial-gradient(36% 36% at 50% 50%, rgba(255,255,255,.6) 0%, rgba(255,255,255,0) 60%), conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 44%, rgba(255,255,255,.9) 50%, rgba(255,255,255,0) 56%, rgba(255,255,255,0) 100%); animation: light-spin 12s linear infinite, light-breath 3s ease-in-out infinite;}
.gaple-board .spinlight-ccw{background: radial-gradient(30% 30% at 50% 50%, rgba(255,255,255,.5) 0%, rgba(255,255,255,0) 55%), conic-gradient(from 20deg at 50% 50%, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 47%, rgba(255,255,255,.85) 50%, rgba(255,255,255,0) 53%, rgba(255,255,255,0) 100%); animation: light-spin-ccw 16s linear infinite, light-breath 3.2s ease-in-out infinite;}
@keyframes light-spin{ to{ transform: rotate(360deg); } }
@keyframes light-breath { 0%,100% { opacity:.75 } 50% { opacity:1 } }
@keyframes light-spin-ccw { to { transform: rotate(-360deg); } }
@media (prefers-reduced-motion: reduce){ .gaple-board .spinlight, .gaple-board .spinlight-ccw{ animation:none } }
.gaple-board .rim{position:absolute; inset:8px; border-radius:12px; pointer-events:none; box-shadow:inset 0 0 0 2px rgba(255,255,255,.1), inset 0 0 0 6px rgba(255,215,0,.14), inset 0 0 36px rgba(255,215,0,.18)}
.gaple-board .rim, .gaple-board .scan{ z-index:2; }
@keyframes scan { from{transform:translateX(-100%)} to{transform:translateX(100%)} }

.domino-grid{position:relative; z-index:3; display:grid; height:100%; padding:16px; gap:12px; grid-template-columns:repeat(7, 1fr); grid-template-rows:repeat(4, 1fr)}

/* === DOMINO === */
.domino{position:relative; width:100%; height:100%; perspective:700px; border-radius:12px; cursor:pointer}
.domino .inner{position:absolute; inset:0; transition:transform .55s cubic-bezier(.2,.8,.2,1); transform-style:preserve-3d; backface-visibility:hidden}
.domino.flipped .inner{transform:rotateY(180deg)}
.face, .back{position:absolute; inset:0; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.15), 0 10px 18px rgba(0,0,0,.42); backface-visibility:hidden}

.back{border:4px solid transparent; background: linear-gradient(180deg,#2a1f55,#1c1044) padding-box, linear-gradient(135deg,#fff6cc 0%, #ffe680 20%, #ffd700 45%, #ffb700 65%, #a86d00 82%, #fff2ac 100%) border-box; display:grid; place-items:center; box-shadow:0 0 18px rgba(255,215,0,.38), inset 0 0 0 1px rgba(255,255,255,.1)}
.back::before{content:""; position:absolute; inset:3px; border-radius:9px; background: linear-gradient(120deg, rgba(255,255,255,.46) 0%, rgba(255,255,255,0) 42%), radial-gradient(120px 60px at 18% 14%, rgba(255,248,220,.22), rgba(255,248,220,0)); mix-blend:screen; pointer-events:none}
.back::after{content:""; position:absolute; left:14px; right:14px; top:12px; bottom:12px; border-radius:10px; background: radial-gradient(70% 60% at 50% 32%, rgba(255,255,255,.95) 0%, rgba(255,255,255,0) 55%), linear-gradient(180deg, #fff6cc 0%, #ffe680 18%, #ffd233 42%, #ffb700 66%, #d08a00 100%); box-shadow: inset 0 10px 16px rgba(255,255,255,.6), inset 0 -12px 18px rgba(168,109,0,.55), 0 0 18px rgba(255,208,0,.42);}
.face{background:linear-gradient(180deg,#ffffff,#f0f0e0); transform:rotateY(180deg); border:1px solid rgba(0,0,0,.15)}
.face::before{content:""; position:absolute; inset:0; border-radius:12px; background:linear-gradient(70deg, rgba(255,255,255,1), rgba(255,255,255,0) 40%); opacity:.55; transform: translateY(-6px) rotate(8deg); pointer-events:none}
.divider{position:absolute; left:50%; top:6px; bottom:6px; width:2px; background:linear-gradient(#c8c8b4,#a1a18d); border-radius:2px}

/* === AREA PIP === */
.half{position:absolute; left:6px; right:6px; height:calc(50% - 8px); display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:4px; padding:6px; place-items:center;}
.half.top{top:6px} .half.bot{bottom:6px}

/* â˜… Pip responsif */
.pip{width: var(--pip, 10px); height: var(--pip, 10px); aspect-ratio: 1 / 1; border-radius:50%; box-shadow:0 1px 1px rgba(0,0,0,.3), inset 0 1px 1px rgba(255,255,255,.3); background:radial-gradient(circle at 30% 30%, #ff4747 0%, #e50000 55%, #a00000 100%);}

.domino.ready .back{ outline:1px solid rgba(255,215,0,.65); box-shadow:0 0 20px rgba(255,215,0,.85), 0 0 38px rgba(255,190,0,.55), 0 0 56px rgba(255,190,0,.35) }
.domino:hover{transform:translateY(-1px)}

/* Shuffle dummy chips */
.shuffle-layer{position:absolute; inset:0; pointer-events:none; z-index:1}
.chip{position:absolute; width:46px; height:22px; border-radius:6px; background:linear-gradient(180deg,#2a1a5e,#1c1044); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12), 0 3px 8px rgba(0,0,0,.6); opacity:0; animation:shuffle-x .9s ease-in-out infinite, shuffle-pop .2s ease forwards; will-change:transform,opacity}
.chip::after{content:""; position:absolute; inset:0; border-radius:6px; background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,.04)); mix-blend:overlay}
@keyframes shuffle-x{0%{transform:translateX(-40px) rotate(-6deg)}50%{transform:translateX(40px) rotate(6deg)}100%{transform:translateX(-40px) rotate(-6deg)}}
@keyframes shuffle-pop{to{opacity:.85}}

/* Tombol robotik */
.controls{display:flex; gap:12px; justify-content:center}
.btn{--pad:12px 20px; position:relative; display:inline-flex; align-items:center; justify-content:center; padding:var(--pad); border-radius:14px; border:1px solid rgba(255,255,255,.2); cursor:pointer; user-select:none; font-family:Orbitron, Roboto, sans-serif; font-weight:800; letter-spacing:.7px; text-transform:uppercase; background:linear-gradient(135deg,#2f1a66,#1a0d49); color:#ffffff; text-shadow:0 1px 1px rgba(0,0,0,.5); box-shadow:inset 0 1px 1px rgba(255,255,255,.15), 0 12px 24px rgba(0,0,0,.48), 0 0 22px rgba(0,198,255,.22); transition:transform .12s ease, box-shadow .2s ease; filter:saturate(1.05)}
.btn.primary{background:linear-gradient(135deg, var(--a), var(--b)); border-color:rgba(255,255,255,.4); color:#000; text-shadow:0 1px 1px rgba(255,255,255,.3)}
.btn::before{content:""; position:absolute; inset:0; border-radius:14px; box-shadow:inset 0 0 0 2px rgba(255,215,0,.28); mix-blend:overlay; opacity:.95; pointer-events:none}
.btn:hover{transform:translateY(-1px); box-shadow:var(--glow-a)}
.btn.primary:hover{box-shadow:var(--glow-a), var(--glow-b)}
#btnStart.disabled, #btnStart:disabled{ 
  background:linear-gradient(to right, #6b7280, #9ca3af) !important;
  cursor:not-allowed !important;
  transform:none !important;
  pointer-events:none !important;
}

/* Kanan: daftar hadiah & result */
.prize-section{padding:10px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1)}
.prize-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background:linear-gradient(160deg,#2a1a5e,#1c1044); box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 2px 5px rgba(0,0,0,.28)}
.badge{font-size:.72rem; padding:4px 8px; border-radius:20px; letter-spacing:.5px; font-weight:700; font-family:Orbitron; box-shadow: inset 0 1px 1px rgba(255,255,255,.28)}
.badge.utama{background:linear-gradient(180deg, #ffd700, #f0c000); color:#4d2c00; border:1px solid #ffde59}
.badge.biasa{background:linear-gradient(180deg, #5bc0de, #46b8da); color:#003366; border:1px solid #7acde6}
.prize-item.highlight{box-shadow:var(--glow-a), var(--glow-b); animation:neon 1.2s ease-in-out infinite}
@keyframes neon{0%,100%{box-shadow:0 0 14px rgba(255,215,0,.7), 0 0 24px rgba(0,198,255,.5)} 50%{box-shadow:0 0 26px rgba(255,215,0,1), 0 0 38px rgba(0,198,255,.75)}}

.prize-result{display:none; margin-top:16px; padding:16px; border-radius:12px; background:linear-gradient(180deg,#2a1a5e,#1c1044); box-shadow:inset 0 0 0 1px rgba(255,255,255,.1)}
.prize-result.show{display:block; animation:up .28s ease}
@keyframes up{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)}}
.result-actions{display:flex; gap:10px; flex-wrap:wrap}
.btn.claim-wa{border-color:rgba(34,139,34,.6); background:linear-gradient(180deg,#2e8b57,#1e6a3f); color:white}
.btn.claim-wa:hover{box-shadow:0 0 12px #32cd32, 0 0 20px #2e8b57}
.btn.claim-tg{border-color:rgba(30,144,255,.6); background:linear-gradient(180deg,#1e90ff,#104e8b); color:white}
.btn.claim-tg:hover{box-shadow:0 0 12px #1e90ff, 0 0 20px #00bfff}

.tiny{font-size:.8rem; color:#d1d9ff}

@media (max-width: 520px){
  .gaple-board{height: clamp(340px, 78vw, 520px)}
  .domino-grid{gap:10px; padding:12px}
  .half{gap:3px; padding:5px}
}
@media (prefers-reduced-motion: reduce){ .gaple-board .scan, .domino.ready{animation:none} }

/* Naikkan posisi panel Hadiah Utama agar lebih dekat ke board */
.hadiah-utama{ margin-top:-75px; }
@media (max-width:1024px){ .hadiah-utama{ margin-top:0; } }

/* ===== ANGKOR WAT EPIC BACKGROUND ===== */
.angkor-bg{position:fixed; inset:0; z-index:-2; overflow:hidden; background:radial-gradient(1200px 900px at 50% 15%, #4b0082 0%, #191970 45%, #050210 100%); contain:paint}
.angkor-bg .sky{position:absolute; inset:-15%; background:linear-gradient(180deg,#ff8c00 0%, #ff4500 35%, #4b0082 65%, #191970 100%); filter:saturate(1.25) brightness(1.08); animation:skyPulse 20s ease-in-out infinite;}
@keyframes skyPulse{0%,100%{filter:saturate(1.15) brightness(1.05)}50%{filter:saturate(1.35) brightness(1.12)}}
.angkor-bg .stars{position:absolute; inset:-10% 0 0 0; background-image:radial-gradient(#fff 1px, transparent 1.2px); background-size:2px 2px; opacity:.2; animation:twinkle 6s ease-in-out infinite}
@keyframes twinkle{0%,100%{opacity:.15}50%{opacity:.25}}
.angkor-bg .sun{position:absolute; top:8vh; left:-20vw; width:min(36vw,520px); height:min(36vw,520px); border-radius:50%; background:radial-gradient(circle at 50% 50%, #ffffff 0%, #fffacd 40%, #ffea00 60%, rgba(255,234,0,0) 70%); filter:blur(7px); opacity:.8; animation:sunGlide 60s linear infinite;}
@keyframes sunGlide{0%{transform:translate(0,0)}50%{transform:translate(60vw,5vh)}100%{transform:translate(120vw,0)}}
.angkor-bg .cloud{position:absolute; left:-40%; width:180%; height:52%; bottom:34%; filter:blur(22px); opacity:.3; mix-blend:screen}
.angkor-bg .cloud.cloud-1{background: radial-gradient(ellipse at 30% 60%, rgba(255,228,181,.23), rgba(255,255,255,0) 60%), radial-gradient(ellipse at 60% 55%, rgba(255,228,181,.2), rgba(255,255,255,0) 60%); animation:fogMove 80s linear infinite}
.angkor-bg .cloud.cloud-2{bottom:28%; opacity:.25; background: radial-gradient(ellipse at 40% 60%, rgba(240,248,255,.23), transparent 60%), radial-gradient(ellipse at 65% 55%, rgba(255,255,255,.18), transparent 60%); animation:fogMove2 110s linear infinite}
@keyframes fogMove{from{transform:translateX(0)}to{transform:translateX(40%)}}
@keyframes fogMove2{from{transform:translateX(-10%)}to{transform:translateX(55%)}}
.angkor-bg svg.temples{position:absolute; left:0; right:0; bottom:-2px; height:58%; width:100%; pointer-events:none}
.angkor-bg .layer.far{fill:#191970; opacity:.7; animation:parFar 60s linear infinite}
.angkor-bg .layer.mid{fill:#100828; opacity:.88; animation:parMid 45s linear infinite}
.angkor-bg .layer.near{fill:#050210; opacity:1; filter:drop-shadow(0 0 22px rgba(0,0,0,.45)); animation:parNear 35s linear infinite}
@keyframes parFar{to{transform:translateX(-2%)}}
@keyframes parMid{to{transform:translateX(-4%)}}
@keyframes parNear{to{transform:translateX(-6%)}}

/* Fireworks canvas & gold edge */
#fxFireworks{position:fixed; inset:0; z-index:5; pointer-events:none; mix-blend-mode:lighter}
:root{ --gold:#ffd700; --gold2:#fff7cc; --gold3:#ffb700; --glow-gold: 0 0 18px rgba(255,215,0,.9), 0 0 36px rgba(255,215,0,.6), 0 0 64px rgba(255,200,0,.4); }
.main-container::after{content:""; position:absolute; inset:0; border-radius:var(--radius); pointer-events:none; padding:2px; background: radial-gradient(220px 160px at 92% 8%, rgba(255,255,255,.9), rgba(255,255,255,0) 60%), linear-gradient(135deg, var(--gold2) 0%, var(--gold) 35%, var(--gold3) 70%, #a86d00 100%); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; filter: drop-shadow(0 0 18px rgba(255,215,0,.95)) drop-shadow(0 0 36px rgba(255,215,0,.65)) drop-shadow(0 0 64px rgba(255,200,0,.42)); opacity:.98; animation: goldBreath 2.6s ease-in-out infinite;}
@keyframes goldBreath{ 0%,100%{ opacity:.92 } 50%{ opacity:1 } }

/* ======== LITE MODE (otomatis untuk HP lemah/hemat data) ======== */
html.lite .angkor-bg{ display:none !important; }
html.lite #fxFireworks{ display:none !important; }
html.lite .panel::after, html.lite .left-panel::after{ display:none !important; }
html.lite .main-container{ backdrop-filter:none; }
html.lite .gaple-board::after{ filter:brightness(1.02) saturate(1.3) blur(3px); opacity:.8; }
html.lite .gaple-board .spinlight, html.lite .gaple-board .spinlight-ccw{ display:none !important; }
html.lite .domino.ready .back{ box-shadow:0 0 12px rgba(255,215,0,.55), 0 0 24px rgba(255,190,0,.35), 0 0 36px rgba(255,190,0,.25); }
html.lite *{ animation-duration: calc(1.25 * var(--anim, 1s)); }
html.lite .prize-item.highlight{ animation:none; }
html.lite .chip{ animation:shuffle-x .7s ease-in-out infinite, shuffle-pop .12s ease forwards; }
</style>
</head>
<body>
<canvas id="fxFireworks" aria-hidden="true"></canvas>

<header class="site-header">
  <div class="brand">BELEGENDTBET</div>
  <a id="goHome" class="home-btn" href="index.html">Beranda</a>
</header>

<div class="angkor-bg" aria-hidden="true">
  <div class="sky" id="angkor-sky"></div>
  <div class="stars"></div>
  <div class="sun"></div>
  <div class="cloud cloud-1"></div>
  <div class="cloud cloud-2"></div>
  <svg class="temples" viewBox="0 0 1200 500" preserveAspectRatio="xMidYMax slice"><g class="layer far"><path d="M0,500 L0,420 L90,420 L120,370 L150,420 L240,420 L270,360 L300,420 L390,420 L420,340 L450,420 L540,420 L570,370 L600,420 L690,420 L720,360 L750,420 L840,420 L870,340 L900,420 L990,420 L1020,370 L1050,420 L1200,420 L1200,500 Z"/></g><g class="layer mid"><path d="M0,500 L0,440 L80,440 L115,380 L150,440 L235,440 L270,360 L305,440 L390,440 L430,320 L470,440 L555,440 L590,380 L625,440 L710,440 L745,360 L780,440 L865,440 L900,325 L935,440 L1020,440 L1055,380 L1090,440 L1200,440 L1200,500 Z"/></g><g class="layer near"><path d="M0,500 L0,460 L70,460 L110,395 L150,460 L230,460 L270,375 L310,460 L390,460 L440,330 L490,460 L570,460 L615,395 L660,460 L740,460 L780,375 L820,460 L900,460 L945,335 L990,460 L1070,460 L1110,395 L1150,460 L1200,460 L1200,500 Z"/></g></svg>
  <div class="water"><svg class="reflection" viewBox="0 0 1200 500" preserveAspectRatio="xMidYMax slice"><g class="layer far"><path d="M0,500 L0,420 L90,420 L120,370 L150,420 L240,420 L270,360 L300,420 L390,420 L420,340 L450,420 L540,420 L570,370 L600,420 L690,420 L720,360 L750,420 L840,420 L870,340 L900,420 L990,420 L1020,370 L1050,420 L1200,420 L1200,500 Z"/></g><g class="layer mid"><path d="M0,500 L0,440 L80,440 L115,380 L150,440 L235,440 L270,360 L305,440 L390,440 L430,320 L470,440 L555,440 L590,380 L625,440 L710,440 L745,360 L780,440 L865,440 L900,325 L935,440 L1020,440 L1055,380 L1090,440 L1200,440 L1200,500 Z"/></g><g class="layer near"><path d="M0,500 L0,460 L70,460 L110,395 L150,460 L230,460 L270,375 L310,460 L390,460 L440,330 L490,460 L570,460 L615,395 L660,460 L740,460 L780,375 L820,460 L900,460 L945,335 L990,460 L1070,460 L1110,395 L1150,460 L1200,460 L1200,500 Z"/></g></svg><div class="surface"></div><div class="ripples"></div><div class="mask"></div></div>
</div>

<div class="main-container" id="app">
  <h1 class="title">DOOR PRIZE GO GAPLE</h1>
  <div class="main-content">
    <section class="left-panel">
      <div class="board-head">
        <div class="board-title">PAPAN GO GAPLE</div>
        <div class="tiny" id="hint"></div>
      </div>
      <div class="gaple-board" id="board">
        <div class="rim"></div>
        <div class="scan"></div>
      </div>
      <div class="controls">
        <button class="btn primary" id="btnStart">PUTAR GO GAPLE</button>
      </div>
    </section>

    <!-- *** POSISI ASLI DIPERTAHANKAN *** -->
    <aside class="panel">
      <h3>HADIAH BIASA</h3>
      <div id="list-biasa" style="display:grid; gap:8px"></div>
    </aside>

    <aside class="panel hadiah-utama">
      <h3>HADIAH UTAMA</h3>
      <div id="list-utama" style="display:grid; gap:8px"></div>
    </aside>

    <aside class="panel">
      <h3>SELAMAT BOSKU DAPAT HADIAHðŸ’¸</h3>
      <div class="prize-result" id="result">
        <div class="tiny" style="margin-bottom:6px">Hasil undian:</div>
        <p class="msg" id="resultMsg">â€”</p>
        <div class="result-actions">
          <a class="btn claim-wa" id="claimWA" target="_blank" rel="noopener">CLAIM HADIAH WA</a>
          <a class="btn claim-tg" id="claimTG" target="_blank" rel="noopener">CLAIM HADIAH TELEGRAM</a>
        </div>
        <p class="tiny" id="footnote" style="margin-top:8px">Kode klaim: TERPAKAI</p>
      </div>
    </aside>
  </div>
</div>

<footer class="site-footer">
  <p>Â© 2025 BELEGENDBET. Hak Cipta Dilindungi Undang-Undang.</p>
</footer>

<script>
/* ==================== OPTIMASI RUNTIME TANPA UBAH STRUKTUR/LOGIKA ==================== */
(function enableLiteMode(){
  const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const saveData = navigator.connection && navigator.connection.saveData;
  const lowMem = navigator.deviceMemory && navigator.deviceMemory <= 3; // <=3GB dianggap low
  const lowCPU = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4; // core sedikit
  if (saveData || prefersReducedMotion || lowMem || lowCPU || innerWidth < 520) {
    document.documentElement.classList.add('lite');
  }
})();

/* ========== CONFIG & DATA ========== */
const BRAND = "DOOR PRIZE GAPLE";
const DEST_WA = "https://klikblg.com/wa-blb";
const DEST_TG = "https://t.me/asupanfreebet";
const MEMBER_LOW_ONLY = true; // hanya 1â€“8 & tanpa balak

// 28 kartu domino (a<=b)
const DECK = (()=>{ const arr=[]; let id=0; for(let a=0;a<=6;a++){ for(let b=a;b<=6;b++){ arr.push({id:++id, a, b, total:a+b, balak:a===b}); } } return arr; })();

/* ======= PRIZE LIST RENDER (DOM tetap sama) ======= */
const listUtama = document.getElementById('list-utama');
const listBiasa = document.getElementById('list-biasa');
(function renderPrizeLists(){
  const fmt = (n)=> n.toLocaleString('id-ID');
  const fragB = document.createDocumentFragment();
  const fragU = document.createDocumentFragment();
  for(let t=1;t<=11;t++){
    const el=document.createElement('div');
    el.className='prize-item'; el.dataset.key='TOTAL-'+t;
    el.innerHTML = `<div><strong>Total Titik ${t}</strong><div class="tiny">Hadiah: Rp${fmt(t*1000)}</div></div><div class="badge biasa">BIASA</div>`;
    fragB.appendChild(el);
  }
  for(let n=0;n<=6;n++){
    const tot=n*2, el=document.createElement('div'); el.className='prize-item'; el.dataset.key='BALAK-'+n;
    el.innerHTML = `<div><strong>Balak ${n} (${n}/${n})</strong><div class="tiny">BIG PRIZE: Rp${fmt((tot===0?1000:tot*1000)*100)}</div></div><div class="badge utama">UTAMA</div>`;
    fragU.appendChild(el);
  }
  listBiasa.appendChild(fragB); listUtama.appendChild(fragU);
})();

/* ========== FIREWORKS (Lazy init supaya tidak berat) ========== */
let FX = null;
function getFX(){
  if (FX) return FX;
  const cvs = document.getElementById('fxFireworks');
  const ctx = cvs.getContext('2d', { alpha:true });
  let W,H, raf=null; const particles=[]; const GRAV=0.05; const FRICTION=0.985;
  const DPR = Math.min(1.5, window.devicePixelRatio||1);
  function resize(){ W=innerWidth; H=innerHeight; cvs.width=W*DPR; cvs.height=H*DPR; cvs.style.width=W+'px'; cvs.style.height=H+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
  let resizeRAF=null; addEventListener('resize', ()=>{ if(resizeRAF) return; resizeRAF=requestAnimationFrame(()=>{ resize(); resizeRAF=null; }); }, {passive:true});
  resize();
  function addBurst({x=W*0.5,y=H*0.3,count=100,spread=Math.PI*2,speed=5,hueBase=Math.random()*360}={}){
    for(let i=0;i<count;i++){
      const a = (i/count)*spread + Math.random()*0.1;
      const sp = speed*(0.6 + Math.random()*0.8);
      particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:60+Math.random()*30,hue:hueBase + (Math.random()*80-40),size:2+Math.random()*2,alpha:1});
    }
    if(!raf) raf=requestAnimationFrame(tick);
  }
  function tick(){
    ctx.clearRect(0,0,W,H);
    if(!particles.length){ raf=null; return; }
    ctx.globalCompositeOperation='lighter';
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.vx*=FRICTION; p.vy*=FRICTION; p.vy+=GRAV; p.x+=p.vx; p.y+=p.vy; p.life--; p.alpha=Math.max(0, p.life/90);
      ctx.fillStyle=`hsla(${p.hue},100%,60%,${p.alpha})`;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
      if(p.life<=0 || p.y>H+20) particles.splice(i,1);
    }
    raf=requestAnimationFrame(tick);
  }
  FX = { burst: (big)=> addBurst({count: big?160:100, speed: big?7:5, hueBase: Math.random()*360}) };
  return FX;
}

/* ========== BOARD LOGIC (tetap sama fungsinya) ========== */
const board = document.getElementById('board');
const btnStart = document.getElementById('btnStart');
const hint = document.getElementById('hint');
const resultBox = document.getElementById('result');
const resultMsg = document.getElementById('resultMsg');
const claimWA = document.getElementById('claimWA');
const claimTG = document.getElementById('claimTG');
const footnote = document.getElementById('footnote');

let canPick = false, busy = false, picked = false, hasSpun = false;
let chosen=null;

/* ====== SESSION COOKIE LOCK (reset kalau browser ditutup) ====== */
const Locker = {
  nameFor(k){ try{ return 'GGS_'+btoa(k).replace(/=+$/,''); }catch(e){ return 'GGS_'+encodeURIComponent(k); } },
  set(k){ try{ document.cookie = this.nameFor(k)+'=1; path=/; SameSite=Lax'; }catch(e){} }, // session cookie
  has(k){
    try{
      const name = this.nameFor(k)+'=';
      return document.cookie.split(';').some(c=>c.trim().startsWith(name));
    }catch(e){ return false; }
  }
};

/* Pip resize (di-throttle biar nggak spam reflow) */
let _pipRAF = null;
function refreshPipSize(){
  if (_pipRAF) return; _pipRAF = requestAnimationFrame(()=>{
    document.querySelectorAll('.face').forEach(face=>{
      const r = face.getBoundingClientRect();
      const unit = Math.min(r.width, r.height);
      const px = Math.max(5, Math.min(10, Math.round(unit * 0.06)));
      face.style.setProperty('--pip', px + 'px');
    });
    _pipRAF = null;
  });
}
addEventListener('resize', refreshPipSize, {passive:true});

function clearHighlights(){ document.querySelectorAll('.prize-item.highlight').forEach(el=>el.classList.remove('highlight')); }

function makeShuffle(){
  board.innerHTML = '<div class="rim"></div><div class="spinlight" aria-hidden="true"></div><div class="spinlight-ccw" aria-hidden="true"></div><div class="scan"></div>';
  const layer = document.createElement('div'); layer.className='shuffle-layer';
  const frag = document.createDocumentFragment(); board.appendChild(layer);
  const bw = board.clientWidth-46, bh = board.clientHeight-22;
  const isLite = document.documentElement.classList.contains('lite');
  const N = isLite ? 12 : 28; // lebih ringan di HP
  for(let i=0;i<N;i++){
    const c=document.createElement('div'); c.className='chip';
    c.style.left=(Math.random()*bw)+'px';
    c.style.top=(Math.random()*bh)+'px';
    c.style.animationDelay=(Math.random()*0.6).toFixed(2)+'s';
    c.style.animationDuration=(0.6+Math.random()*0.9).toFixed(2)+'s';
    frag.appendChild(c);
  } layer.appendChild(frag);
  hint.textContent = 'Mengacak kartu...';
}

function showGrid(){
  board.innerHTML = '<div class="rim"></div><div class="spinlight" aria-hidden="true"></div><div class="spinlight-ccw" aria-hidden="true"></div><div class="scan"></div>';
  const grid = document.createElement('div'); grid.className='domino-grid';
  const frag = document.createDocumentFragment();
  for(let i=0;i<28;i++) { frag.appendChild(makeBackDomino()); }
  grid.appendChild(frag); board.appendChild(grid);
  refreshPipSize();
  if (forcedPrizeObj) { hint.textContent = 'Pilih 1 kartu mana saja buka hadiah BoskuðŸ’Ž'; }
  else { hint.textContent = canPick ? 'PILIH 1 GAPLE' : 'ðŸ’¡SPIN PUTAR GO GAPLE'; }
}

function makeBackDomino(){
  const root = document.createElement('div'); root.className='domino ready';
  const inner = document.createElement('div'); inner.className='inner'; root.appendChild(inner);
  const back = document.createElement('div'); back.className='back'; inner.appendChild(back);
  const face = document.createElement('div'); face.className='face'; inner.appendChild(face);
  const divv = document.createElement('div'); divv.className='divider'; face.appendChild(divv);
  const top = document.createElement('div'); top.className='half top'; face.appendChild(top);
  const bot = document.createElement('div'); bot.className='half bot'; face.appendChild(bot);
  root.addEventListener('click', ()=> onPick(root, top, bot), {passive:true});
  return root;
}

// Flag admin (sheet)
let forcedPrizeIdx = -1;
let forcedPrizeObj = null;

function onPick(cardEl, topHalf, botHalf) {
  let kartu = null;
  
  if (forcedPrizeObj) {
    picked = true; canPick = false; busy = true;
    document.querySelectorAll('.domino').forEach(n => { n.classList.remove('ready'); n.style.pointerEvents = 'none'; });
    drawHalf(topHalf, forcedPrizeObj.a);
    drawHalf(botHalf, forcedPrizeObj.b);
    cardEl.classList.add('flipped');
    cardEl.classList.add('auto-flip');
    refreshPipSize();
    kartu = forcedPrizeObj;
  } else {
    if(!canPick || busy || picked){ if(!canPick && !busy) { hint.textContent = 'ðŸ’¡SPIN PUTAR GO GAPLE'; } return; }
    
    picked = true; canPick = false; busy = true;
    document.querySelectorAll('.domino').forEach(n=>{ n.classList.remove('ready'); n.style.pointerEvents='none'; });
    const pool = DECK.filter(t=> MEMBER_LOW_ONLY ? (!t.balak && t.total>=1 && t.total<=8) : true);
    kartu = pool[Math.floor(Math.random()*pool.length)];
    chosen = kartu;
    drawHalf(topHalf, kartu.a); drawHalf(botHalf, kartu.b);
    refreshPipSize(); cardEl.classList.add('flipped');
  }
  // === TAMPILKAN HASIL & HIGHLIGHT ===
  clearHighlights();
  let hadiahNum = 0, hadiahStr = '-', hadiahKey = '';
  if (kartu.balak) {
    hadiahKey = 'BALAK-' + kartu.a;
    switch (kartu.a) {
      case 0: hadiahNum = 100000; break;
      case 1: hadiahNum = 200000; break;
      case 2: hadiahNum = 400000; break;
      case 3: hadiahNum = 600000; break;
      case 4: hadiahNum = 800000; break;
      case 5: hadiahNum = 1000000; break;
      case 6: hadiahNum = 1200000; break;
    }
  } else {
    hadiahKey = 'TOTAL-' + (kartu.a + kartu.b);
    const hadiahMap = {
      '0-1':1000, '0-2':2000, '0-3':3000, '0-4':4000, '0-5':5000, '0-6':6000,
      '1-2':3000, '1-3':4000, '1-4':5000, '1-5':6000, '1-6':7000,
      '2-3':5000, '2-4':6000, '2-5':7000, '2-6':8000,
      '3-4':7000, '3-5':8000, '3-6':9000,
      '4-5':9000, '4-6':10000,
      '5-6':11000
    };
    const key = kartu.a + '-' + kartu.b;
    hadiahNum = hadiahMap[key] || 0;
  }
  if (hadiahNum) hadiahStr = `Rp${hadiahNum.toLocaleString('id-ID')}`;
  const el = document.querySelector('.prize-item[data-key="' + hadiahKey + '"]'); if (el) el.classList.add('highlight');
  resultMsg.innerHTML = `Selamat! Kamu mendapatkan <strong>${hadiahStr}</strong>`;
  claimWA.setAttribute('href', DEST_WA);
  claimTG.setAttribute('href', DEST_TG);
  
  // PLAY CHA-CHING SOUND UNTUK HADIAH GAPLE
  playChaChing();
  
  resultBox.classList.add('show');
  lockIfPlayed();
  busy = false;
  return;
}

/* ===== PIP LAYOUT ===== */
const POS = { TL:[0,0], TC:[1,0], TR:[2,0], CL:[0,1], CC:[1,1], CR:[2,1], BL:[0,2], BC:[1,2], BR:[2,2] };
const LAYOUTS = { 0:[], 1:['CC'], 2:['TL','BR'], 3:['TL','CC','BR'], 4:['TL','TR','BL','BR'], 5:['TL','TR','CC','BL','BR'], 6:['TL','TR','CL','CR','BL','BR'] };
function drawHalf(container, n){
  container.innerHTML='';
  const keys = LAYOUTS[n];
  for(let i=0;i<keys.length;i++){
    const key = keys[i], p=document.createElement('span'); p.className='pip';
    p.style.gridColumnStart=POS[key][0]+1; p.style.gridRowStart=POS[key][1]+1;
    container.appendChild(p);
  }
}

/* ===== UTIL ===== */
function getParamInsensitive(name, src){
  const want = name.toLowerCase();
  const p = src || new URLSearchParams(location.search);
  for(const [k,v] of p.entries()){ if(k.toLowerCase() === want) return v; }
  return null;
}
function getCoupon(){
  let c =
    getParamInsensitive('kupon')      || getParamInsensitive('coupon')   ||
    getParamInsensitive('kupon_id')   || getParamInsensitive('coupon_id')||
    getParamInsensitive('code');
  if(!c && location.hash){
    const h = new URLSearchParams(location.hash.slice(1));
    c = getParamInsensitive('kupon',h) || getParamInsensitive('coupon',h) ||
        getParamInsensitive('kupon_id',h) || getParamInsensitive('coupon_id',h) ||
        getParamInsensitive('code',h);
  }
  return (c || '').trim();
}
const COUPON = getCoupon();
function getPlayKey(){ return COUPON ? ('GO_GAPLE_PLAYED:' + COUPON.toUpperCase()) : 'GO_GAPLE_PLAYED:DEFAULT'; }

/* ===== LOCK HELPERS ===== */
function isPlayed(){ return Locker.has(getPlayKey()); }
function lockIfPlayed(){
  const s = JSON.parse(localStorage.getItem('tm_session')||'null');
  function isClaimed(kupon) { if (!kupon) return false; return localStorage.getItem('tm_claimed_'+kupon) === '1'; }
  if(isPlayed() || isClaimed(s?.kupon) || hasSpun){
    btnStart.disabled = true;
    btnStart.textContent = 'ðŸš« SUDAH DIGUNAKAN';
    btnStart.style.filter = 'grayscale(0.7) brightness(0.9)';
    btnStart.style.background = 'linear-gradient(to right, #6b7280, #9ca3af)';
    btnStart.style.cursor = 'not-allowed';
    hint.textContent = 'CLAIM SCROOL KEBEWAH BOSKU ðŸ‘‡';
    hasSpun = true; // Set flag hasSpun
    return true;
  }
  btnStart.disabled = false;
  btnStart.textContent = 'PUTAR GO GAPLE';
  btnStart.style.filter = '';
  btnStart.style.background = '';
  btnStart.style.cursor = '';
  hint.textContent = 'ðŸ’¡SPIN PUTAR GO GAPLE';
  return false;
}
function setPlayedOnce(){ Locker.set(getPlayKey()); }

/* ===== START BUTTON ===== */
const btnStartHandler = ()=>{
  if(busy || hasSpun) return; // Cegah jika sudah pernah spin
  if(isPlayed()) { lockIfPlayed(); return; }

  // MULAI SUARA BEEP BEEP UNTUK GAPLE SPIN
  startBeepSound();

  picked = false;
  resultBox.classList.remove('show');
  clearHighlights();

  canPick = false; busy = true; hasSpun = true; // Set flag hasSpun ke true
  btnStart.disabled=true;
  
  // Disable tombol dan ubah tampilannya
  btnStart.textContent = 'âš¡ MEMUTAR...';
  btnStart.style.background = 'linear-gradient(to right, #6b7280, #9ca3af)';
  btnStart.style.cursor = 'not-allowed';
  
  hint.textContent='Mengacak kartu...';
  makeShuffle();

  const s = JSON.parse(localStorage.getItem('tm_session')||'null');
  function setClaimed(kupon) { if (!kupon) return; localStorage.setItem('tm_claimed_'+kupon, '1'); }
  function isClaimed(kupon) { if (!kupon) return false; return localStorage.getItem('tm_claimed_'+kupon) === '1'; }
  if (!s?.userId || !s?.kupon) {
    setTimeout(()=>{
      resultMsg.innerHTML = 'Session tidak valid. Silakan login ulang.';
      resultBox.classList.add('show');
      hasSpun = true; // Set flag hasSpun
      lockIfPlayed();
      busy = false;
      btnStart.disabled = false;
    }, 800);
    return;
  }
  if (isClaimed(s.kupon)) {
    setTimeout(()=>{
      resultMsg.innerHTML = 'Kupon sudah pernah dipakaiâ›”';
      resultBox.classList.add('show');
      hasSpun = true; // Set flag hasSpun
      lockIfPlayed();
      busy = false;
      btnStart.disabled = false;
    }, 800);
    return;
  }
  const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
  const url = `${apiUrl}?action=catat&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`;
  fetch(url, { cache:'no-store' })
    .then(async res => {
      let data; try { data = await res.json(); } catch(e) { data = {success:false, msg:'Response bukan JSON'}; }
      if (data.success) {
        function getPrizeForCard(t) {
          if (t.balak) {
            switch (t.a) {
              case 0: return 100000; case 1: return 200000; case 2: return 400000; case 3: return 600000; case 4: return 800000; case 5: return 1000000; case 6: return 1200000;
            }
          } else {
            const hadiahMap = { '0-1':1000,'0-2':2000,'0-3':3000,'0-4':4000,'0-5':5000,'0-6':6000,
              '1-2':3000,'1-3':4000,'1-4':5000,'1-5':6000,'1-6':7000,
              '2-3':5000,'2-4':6000,'2-5':7000,'2-6':8000,
              '3-4':7000,'3-5':8000,'3-6':9000,
              '4-5':9000,'4-6':10000,
              '5-6':11000 };
            const key = t.a + '-' + t.b; return hadiahMap[key] || 0;
          }
        }
        const hadiahNum = Number(data.hadiah);
        let matchIdx = -1; let match = null;
        for (let i = 0; i < DECK.length; i++) { const t = DECK[i]; if (getPrizeForCard(t) === hadiahNum) { matchIdx = i; match = t; break; } }
        if (matchIdx !== -1) { forcedPrizeIdx = matchIdx; forcedPrizeObj = match; } else { forcedPrizeIdx = -1; forcedPrizeObj = null; }
        setClaimed(s.kupon);
        hasSpun = true; // Pastikan flag hasSpun diset
        lockIfPlayed();
      } else {
        forcedPrizeIdx = -1; forcedPrizeObj = null;
        resultMsg.innerHTML = data.msg || 'Gagal mencatat hadiah!';
        resultBox.classList.add('show');
        hasSpun = true; // Set flag hasSpun walaupun gagal
        lockIfPlayed();
      }
      setTimeout(()=>{
        // STOP SUARA BEEP SETELAH SHUFFLE SELESAI
        stopBeepSound();
        
        showGrid();
        // Jangan enable tombol lagi jika sudah spin
        if (!hasSpun) {
          btnStart.disabled=false;
        }
        canPick = true;
        busy = false;
        if (forcedPrizeIdx !== -1) hint.textContent = 'PILIH 1 GAPLE DAPATKAN HADIAHðŸ•Šï¸'; else hint.textContent = 'PILIH 1 GAPLE';
      }, 800);
    })
    .catch(() => {
      forcedPrizeIdx = -1; forcedPrizeObj = null;
      setTimeout(()=>{
        resultMsg.innerHTML = 'Gagal menghubungi server. Coba lagi.';
        resultBox.classList.add('show');
        hasSpun = true; // Set flag hasSpun saat error
        lockIfPlayed();
        busy = false;
        btnStart.disabled = false;
      }, 800);
    });
};
btnStart.addEventListener('click', btnStartHandler, {passive:true});

/* ===== INIT ===== */
(function init(){
  const idle = window.requestIdleCallback || function(cb){ return setTimeout(cb,1); };
  idle(()=>{ showGrid(); refreshPipSize(); });
  // Cek kupon ke API saat buka halaman (lebih singkat timeoutnya)
  const s = JSON.parse(localStorage.getItem('tm_session')||'null');
  function setClaimed(kupon) { if (!kupon) return; localStorage.setItem('tm_claimed_'+kupon, '1'); }
  function isClaimed(kupon) { if (!kupon) return false; return localStorage.getItem('tm_claimed_'+kupon) === '1'; }
  if (isClaimed(s?.kupon)) {
    hasSpun = true; // Set flag hasSpun
    lockIfPlayed();
    resultMsg.innerHTML = 'Kupon sudah pernah dipakaiâ›”';
    resultBox.classList.add('show');
  } else if (s?.userId && s?.kupon) {
    const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
    fetch(`${apiUrl}?action=claim&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`, { cache:'no-store' })
      .then(res=>res.json())
      .then(data=>{
        if (data.msg && data.msg.toLowerCase().includes('terpakai')) {
          hasSpun = true; // Set flag hasSpun
          lockIfPlayed();
          resultMsg.innerHTML = 'Kupon sudah pernah dipakaiâ›”';
          resultBox.classList.add('show');
          setClaimed(s.kupon);
        }
      }).catch(()=>{});
  }
})();

/* ==== SISTEM AUDIO - 3 SUARA GAPLE ==== */
let audioCtx;
let beepSound = null;
let isBeepPlaying = false;

function getCtx(){ 
  if(!audioCtx){ 
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
      console.log('Audio context created, state:', audioCtx.state);
    } catch (e) {
      console.error('Failed to create audio context:', e);
      return null;
    }
  } 
  if(audioCtx.state === 'suspended') {
    audioCtx.resume().then(() => {
      console.log('Audio context resumed, state:', audioCtx.state);
    }).catch(e => {
      console.error('Failed to resume audio context:', e);
    });
  }
  return audioCtx; 
}

// Initialize audio context on first user interaction
let audioInitialized = false;
function initAudioOnInteraction() {
  if (audioInitialized) return;
  audioInitialized = true;
  try { 
    getCtx(); 
    console.log('Audio initialized on user interaction');
  } catch(e) {
    console.error('Audio initialization failed:', e);
  }
}

window.addEventListener('pointerdown', initAudioOnInteraction, {once:true, passive:true});
window.addEventListener('click', initAudioOnInteraction, {once:true, passive:true});
window.addEventListener('touchstart', initAudioOnInteraction, {once:true, passive:true});

// 1. SUARA BEEP BEEP untuk TOMBOL PUTAR GO GAPLE
function createBeepSound() {
  try {
    const ctx = getCtx();
    if (!ctx) return null;
    
    // Buat oscillator untuk suara beep
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    
    osc1.type = 'square';
    osc1.frequency.value = 800; // High frequency beep
    
    osc2.type = 'sine';
    osc2.frequency.value = 600; // Lower harmonic
    
    // Gain untuk masing-masing oscillator
    const gain1 = ctx.createGain();
    const gain2 = ctx.createGain();
    const masterGain = ctx.createGain();
    
    gain1.gain.value = 0.4;
    gain2.gain.value = 0.2;
    masterGain.gain.value = 0;
    
    // High-pass filter untuk suara beep yang crisp
    const filter = ctx.createBiquadFilter();
    filter.type = 'highpass';
    filter.frequency.value = 400;
    filter.Q.value = 2;
    
    // Connection
    osc1.connect(gain1);
    osc2.connect(gain2);
    gain1.connect(filter);
    gain2.connect(filter);
    filter.connect(masterGain);
    masterGain.connect(ctx.destination);
    
    return { 
      osc1: osc1, 
      osc2: osc2, 
      gain: masterGain, 
      filter: filter,
      gain1: gain1,
      gain2: gain2
    };
  } catch (e) {
    console.error('Error creating beep sound:', e);
    return null;
  }
}

function startBeepSound() {
  if (isBeepPlaying) return;
  
  try {
    const ctx = getCtx();
    console.log('Starting beep beep sound for gaple spin...');
    
    if (ctx.state === 'suspended') {
      ctx.resume();
    }
    
    isBeepPlaying = true;
    
    // Buat pattern beep-beep berulang
    let beepCount = 0;
    const maxBeeps = 8; // Total beep selama shuffle
    
    const createSingleBeep = () => {
      if (!isBeepPlaying || beepCount >= maxBeeps) {
        isBeepPlaying = false;
        return;
      }
      
      beepSound = createBeepSound();
      if (beepSound) {
        const currentTime = ctx.currentTime;
        
        // Start oscillators
        beepSound.osc1.start(currentTime);
        beepSound.osc2.start(currentTime);
        
        // Beep pattern: on 0.1s, off 0.1s
        beepSound.gain.gain.setValueAtTime(0, currentTime);
        beepSound.gain.gain.linearRampToValueAtTime(0.6, currentTime + 0.01);
        beepSound.gain.gain.linearRampToValueAtTime(0.6, currentTime + 0.08);
        beepSound.gain.gain.linearRampToValueAtTime(0, currentTime + 0.1);
        
        // Stop after beep duration
        setTimeout(() => {
          try {
            if (beepSound) {
              beepSound.osc1.stop();
              beepSound.osc2.stop();
            }
          } catch (e) {
            console.warn('Beep oscillators already stopped:', e);
          }
        }, 120);
        
        beepCount++;
        
        // Schedule next beep
        setTimeout(createSingleBeep, 200);
      }
    };
    
    createSingleBeep();
  } catch (e) {
    console.error('Error starting beep sound:', e);
    isBeepPlaying = false;
  }
}

function stopBeepSound() {
  isBeepPlaying = false;
  console.log('Stopping beep sound...');
}

// 2. SUARA CHA-CHING untuk HADIAH GAPLE
function playChaChing(){
  try {
    const ctx = getCtx(); 
    const t0 = ctx.currentTime + 0.02;
    
    const o1 = ctx.createOscillator(); 
    o1.type='triangle'; 
    const g1 = ctx.createGain(); 
    g1.gain.setValueAtTime(0.0001, t0); 
    g1.gain.exponentialRampToValueAtTime(0.7, t0+0.02); 
    g1.gain.exponentialRampToValueAtTime(0.0001, t0+0.7); 
    o1.frequency.setValueAtTime(1100, t0); 
    o1.frequency.exponentialRampToValueAtTime(1600, t0+0.08);
    
    const o2 = ctx.createOscillator(); 
    o2.type='square';   
    const g2 = ctx.createGain(); 
    g2.gain.setValueAtTime(0.0001, t0); 
    g2.gain.exponentialRampToValueAtTime(0.35, t0+0.02); 
    g2.gain.exponentialRampToValueAtTime(0.0001, t0+0.55); 
    o2.frequency.setValueAtTime(660, t0);  
    o2.frequency.exponentialRampToValueAtTime(990, t0+0.06);
    
    const nDur=0.09; 
    const b = ctx.createBuffer(1, ctx.sampleRate*nDur, ctx.sampleRate); 
    const d=b.getChannelData(0); 
    for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    
    const n = ctx.createBufferSource(); 
    n.buffer=b; 
    const ng=ctx.createGain(); 
    ng.gain.setValueAtTime(0.4, t0); 
    ng.gain.exponentialRampToValueAtTime(0.0001, t0+nDur);
    
    o1.connect(g1).connect(ctx.destination); 
    o2.connect(g2).connect(ctx.destination); 
    n.connect(ng).connect(ctx.destination);
    
    o1.start(t0); 
    o2.start(t0+0.02); 
    n.start(t0); 
    o1.stop(t0+0.7); 
    o2.stop(t0+0.55); 
    n.stop(t0+nDur);
    
    console.log('Playing cha-ching sound for gaple prize');
  } catch (e) {
    console.warn('Error playing cha-ching sound:', e);
  }
}

// Cleanup suara saat halaman ditutup atau kehilangan focus
window.addEventListener('beforeunload', () => {
  stopBeepSound();
});

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopBeepSound();
  }
});
</script>
</body>
</html>
