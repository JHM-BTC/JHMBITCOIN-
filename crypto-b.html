<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Neon Crypto Event — Spin & Prize (v15.3 FAST)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet" />

<!-- Speed up icons host -->
<link rel="dns-prefetch" href="//i.postimg.cc">
<link rel="preconnect" href="https://i.postimg.cc" crossorigin>

<!-- Preload ALL coin icons -->
<link rel="preload" as="image" href="https://i.postimg.cc/V6wtcHDP/e97e725d-7c9e-46bb-ba18-12ac2229a4ed.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/KjwLCcWJ/6904c3e5-64b9-40bc-b720-146bce9c52ef.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/JzG4dVVd/7b78591f-a68b-4879-8e41-9f55d7c2a5fa.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/bvmZKNDk/cd74f159-0772-473f-acf9-3ba299c81b9e.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/pLtqsxFP/4127a945-5034-4d26-bcf2-3acf8078a839.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/4dn5YxrQ/d520c648-132e-4221-a564-49217775aca4.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/fbR7PbTQ/0dd15455-9843-4b80-995e-92b85570d004.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/1RqG22PX/f75bf0b6-bf94-4796-9f51-9fb2ea8e4de9.png" crossorigin="anonymous">
<link rel="preload" as="image" href="https://i.postimg.cc/k5LVyM2c/93b53129-af39-4f31-8711-5f7adbb9cdf7.png" crossorigin="anonymous">

<style>
/* ====== GLOBAL ====== */
*{ box-sizing:border-box }
:root{
  --muted:#94a3b8; --txt:#e2e8f0; --p:#38bdf8; --s:#a855f7; --g:#10b981; --r:#ef4444;
  --card:rgba(16,22,42,.7);
  --ring: conic-gradient(from 0deg, #ff0044, #ff7f00 16%, #ffee00 32%, #00ff87 48%, #00b3ff 64%, #7b2cff 80%, #ff00d4 96%, #ff0044);
  --slotInset:16px; --hdr-h:46px; --subftr-h:32px;
  /* gap aman antara header fixed dan konten (anti “mentok”) */
  --top-gap: clamp(18px, 3.5vh, 44px);
}
html, body{ height:100% }
body{
  margin:0; color:var(--txt); font-family:'Roboto Mono',monospace; min-height:100vh; overflow-x:hidden;
  background:
    radial-gradient(1200px 800px at var(--mx,50%) var(--my,40%), rgba(168,85,247,.18), transparent 60%),
    radial-gradient(900px 600px at calc(100% - var(--mx,50%)) calc(100% - var(--my,40%)), rgba(56,189,248,.18), transparent 60%), #070b14;
  transition: background-position .2s ease;
}

/* ===== Top header & bottom copyright bar ===== */
.siteHeader{ position:fixed; top:0; left:0; right:0; height:var(--hdr-h); z-index:120; color:#e5e7eb;
  backdrop-filter:saturate(1.2) blur(6px);
  background:linear-gradient(90deg,#0b1530,#1f2b6b 40%,#3b2a8a 70%,#6a2acb);
  border-bottom:1px solid rgba(255,255,255,.08);
  box-shadow:0 4px 18px rgba(0,0,0,.35)
}
.siteHeader .spread{ width:100%; height:100%; padding:0 12px; display:flex; align-items:center; justify-content:space-between }
.brand{ font-family:'Bebas Neue',sans-serif; letter-spacing:.06em; font-size:18px; color:#d7ccff; text-shadow:0 1px 0 rgba(0,0,0,.35) }
.homeBtn{ display:inline-block; padding:.35rem .7rem; border-radius:.6rem; font-weight:800; letter-spacing:.02em; color:#06101e;
  background:linear-gradient(180deg,#7dd3fc,#38bdf8);
  box-shadow:0 2px 10px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.6);
  border:1px solid rgba(255,255,255,.35)
}
.homeBtn:hover{ filter:brightness(1.05) }
.subFooter{
  position:fixed; bottom:0; left:0; right:0; height:var(--subftr-h); z-index:110; display:grid; place-items:center;
  font-size:.78rem; color:#eaf6ff; text-shadow:0 1px 0 rgba(0,0,0,.4);
  background:linear-gradient(90deg,#0b1530,#1f2b6b 55%,#3b2a8a);
  border-top:1px solid rgba(255,255,255,.08)
}

/* SAFE PADDING: tambah jarak dari header & notch iOS */
.pagePadAll{
  padding-top: calc(var(--hdr-h) + var(--top-gap) + env(safe-area-inset-top,0px));
  padding-bottom: calc(var(--subftr-h) + 12px + env(safe-area-inset-bottom,0px));
}

/* canvas bintang */
.space{ position:fixed; inset:0; z-index:0; pointer-events:none }
.space canvas{ width:100%; height:100%; display:block }

/* container tengah */
.shell{ position:relative; z-index:10; max-width:1200px; margin-inline:auto; width:min(1200px, 100%); padding-inline: clamp(12px, 3vw, 24px) }
.neon{
  position:relative; border-radius:1.25rem;
  padding: clamp(1rem, 2.2vw, 2rem);
  background:var(--card); backdrop-filter: blur(12px);
  box-shadow: 0 0 40px rgba(56,189,248,.25), inset 0 0 24px rgba(168,85,247,.12); isolation:isolate;
  margin-top: .25rem; /* jaga jarak visual ekstra dari header */
}
.neon:before{ content:""; position:absolute; inset:-2px; border-radius:inherit; background:var(--ring); filter:blur(8px); z-index:-1 }
.neon:after{
  content:""; position:absolute; inset:8px; border-radius:inherit;
  background: conic-gradient(from 0deg, #ff00d4, #ff7f00, #ffee00, #00ff87, #00b3ff, #7b2cff, #ff00d4);
  background-size:200% 200%; background-position:0% 0%; animation: cornerFlow 16s ease-in-out infinite;
  filter: blur(24px) saturate(1.1); opacity:.34; mix-blend-mode:screen; z-index:-1
}
@keyframes cornerFlow{ 0%{background-position:0% 0%} 50%{background-position:100% 100%} 100%{background-position:0% 0%} }
.title{ font-family:'Bebas Neue',sans-serif; letter-spacing:.06em; text-shadow:0 0 16px rgba(56,189,248,.6), 0 0 28px rgba(168,85,247,.5) }
.dot{ width:.7rem; height:.7rem; border-radius:999px; background:var(--g); box-shadow:0 0 10px var(--g); animation:pulse 1.6s infinite }
@keyframes pulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.35) } }

/* ===== Mini Crypto Chart ===== */
.miniChart{ border-radius:12px; background:linear-gradient(180deg,#0b1220,#141b2e); border:1px solid rgba(255,255,255,.06);
  box-shadow:0 12px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04); overflow:hidden }
.miniChart .chart{ height: clamp(220px, 36vh, 320px) } /* responsive tinggi chart */
.mc-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06);
  background:linear-gradient(90deg,rgba(30,41,72,.7),rgba(18,26,44,.7)); color:#c7d2fe; flex-wrap:wrap }
.mc-title{ font-weight:800; letter-spacing:.02em }
.mc-tools{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.mc-select{ display:flex; align-items:center; gap:6px; color:#94a3b8; font-size:.85rem }
.mc-select select{ appearance:none; background:#0f172a; color:#e2e8f0; border:1px solid rgba(255,255,255,.08); border-radius:.5rem; padding:.35rem .6rem }
.mc-chips{ display:flex; align-items:center; gap:6px; flex-wrap:wrap }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:.28rem .6rem; border-radius:.6rem; background:#0f172a; color:#cbd5e1;
  border:1px solid rgba(255,255,255,.08); font-weight:700; font-size:.85rem }
.chip.active{ background:linear-gradient(180deg,#312e81,#1e40af); color:#e5edff; box-shadow:0 0 0 1px rgba(99,102,241,.5) inset }
.chip.input{ padding:.2rem .4rem }
.chip.input input{ width:54px; background:transparent; color:#e2e8f0; border:none; outline:none; text-align:center; font-weight:800 }

/* grid konten, stack di mobile */
/* Jarak antar kolom grid dan pedal slot */
.grid-2{ display:grid; gap:1.25rem }
@media (min-width:980px){
  .grid-2{ grid-template-columns: 1fr 1fr }
  .slotStage { margin-right: 32px; }
}
@media (max-width:979px){
  .slotStage { margin-right: 0; }
}

/* SLOT MACHINE AREA */
.slotStage{ display:grid; place-items:center }
.slotBox{
  position:relative; width:min(420px,100%); height: clamp(260px, 58vw, 400px); border-radius:1.1rem;
  background:
    radial-gradient(120% 140% at 20% -10%, rgba(255,255,255,.35), transparent 60%),
    radial-gradient(120% 140% at 120% 120%, rgba(255,255,255,.28), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,250,255,.92));
  border:1px solid rgba(226,232,240,.85); overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.35) inset, 0 0 80px rgba(255,255,255,.35) inset, 0 0 120px rgba(168,85,247,.12) inset;
}
.picker{ position:absolute; left:6%; right:6%; top:50%; transform:translateY(-50%); height:3rem; border:0;
  background:
    linear-gradient(90deg, transparent, rgba(56,189,248,.6), transparent) 0 50%/100% 2px no-repeat,
    linear-gradient(90deg, transparent, rgba(167,139,250,.35), transparent) 0 calc(50% + 1.3rem)/100% 1px no-repeat,
    linear-gradient(90deg, transparent, rgba(167,139,250,.35), transparent) 0 calc(50% - 1.3rem)/100% 1px no-repeat;
  filter: drop-shadow(0 0 16px rgba(56,189,248,.7)); pointer-events:none
}
.picker::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(56,189,248,.08), transparent); opacity:0 }

.reel{ display:flex; flex-direction:column; transform:translateY(0); will-change: transform; backface-visibility: hidden; visibility:hidden; position:absolute; inset:var(--slotInset) }
.cell{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.45rem; height:18rem }
.cell img{ width: clamp(70px, 18vw, 110px); height:auto; object-fit:contain; filter: drop-shadow(0 0 14px rgba(56,189,248,.25)) }

.cta{ font-family:'Bebas Neue',sans-serif; letter-spacing:.06em; padding:.9rem 2.6rem; border-radius:.8rem; background:linear-gradient(45deg, var(--p), var(--s));
  color:#0b0f1a; font-size: clamp(1.1rem, 2.6vw, 1.5rem); font-weight:700; box-shadow:0 8px 40px rgba(56,189,248,.4) }

/* Board hadiah responsif */
.board{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap:.8rem; max-height:none; overflow:visible; padding-right:0
}
.row{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:.45rem; padding:.9rem; border-radius:.9rem;
  background:linear-gradient(180deg,#fffaf0,#f6edd8); border:1px solid rgba(17,24,39,.08);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.65), 0 .5px 0 rgba(255,255,255,.4), 0 10px 20px rgba(0,0,0,.12);
  color:#0b1220; position:relative; overflow:hidden; transition:transform .15s ease, box-shadow .15s ease, background .2s ease
}
.row .amt{ font-weight:700; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.35) }
.row.active{ box-shadow:0 0 0 2px rgba(56,189,248,.45) inset, 0 0 16px rgba(56,189,248,.25) inset }
.row::before{ content:""; position:absolute; inset:0; border-radius:inherit;
  background: linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,0) 38%),
              radial-gradient(80% 60% at 50% -20%, rgba(255,255,255,.45), transparent 60%);
  mix-blend-mode:screen; pointer-events:none }
.row:hover{ transform:translateY(-2px);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.75), 0 12px 28px rgba(0,0,0,.18), 0 0 22px rgba(255,255,255,.25) }
.row .name{ color:#0b1220; font-weight:600; text-shadow:0 1px 0 rgba(255,255,255,.35) }

.overlay{ position:fixed; inset:0; background:rgba(0,0,0,.78); display:none; place-items:center; z-index:50 }
.modal{ width:min(520px, 92vw); background:rgba(16,22,42,.95); border-radius:1rem; padding:2rem; border:1px solid rgba(56,189,248,.35);
  box-shadow:0 0 36px rgba(56,189,248,.2) }

/* Prefer reduced motion */
@media (prefers-reduced-motion: reduce){
  .reel{ transition:none !important }
  .spinning .vItem .logo{ animation:none !important }
}

/* Frame/ornamen slot */
.slotBox::before{
  content:""; position:absolute; inset:-1.5px; border-radius:inherit; padding:1.5px;
  background: conic-gradient(from 0deg, #22d3ee, #a78bfa, #22d3ee);
  -webkit-mask: linear-gradient(#0000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  animation: spin 10s linear infinite; opacity:.95; pointer-events:none
}
.slotBox::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(60% 45% at 50% 35%, rgba(255,255,255,.32), rgba(255,255,255,.08) 60%, transparent 75%),
              radial-gradient(70% 60% at 50% 120%, rgba(255,255,255,.25), rgba(255,255,255,.05));
  pointer-events:none
}
.slotBox .glare{ position:absolute; left:6%; right:6%; top:8%; height:68px; border-radius:999px;
  background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.02)); filter: blur(10px); opacity:.45; pointer-events:none }
.picker::before{
  content:""; position:absolute; left:50%; top:50%; transform: translate(-50%, -50%) rotate(45deg); width:12px; height:12px; border-radius:2px;
  background:#22d3ee; box-shadow: 0 0 18px rgba(34,211,238,.6)
}
@keyframes spin{ to{ transform:rotate(360deg) } }

/* WIN highlight + neon flash */
.row.win{ border:1px solid rgba(255,72,108,.95);
  box-shadow:0 0 0 3px rgba(255,72,108,.9) inset, 0 0 32px rgba(255,0,90,.75), 0 0 80px rgba(255,0,90,.5);
  background:linear-gradient(180deg,#fff0f3,#ffe0e7) }
.row.win .name, .row.win .amt{ color:#3b0a12; text-shadow:0 1px 0 rgba(255,255,255,.6) }
.row.flash{ border-color:rgba(255,72,108,.98)!important;
  box-shadow:0 0 0 3px rgba(255,72,108,1) inset, 0 0 36px rgba(255,0,90,.95), 0 0 90px rgba(255,0,90,.7), 0 0 140px rgba(255,0,90,.55);
  animation:neonBlink 1.6s ease-in-out 1
}
.row.flash::after{
  content:""; position:absolute; inset:-2px; border-radius:inherit; pointer-events:none; mix-blend-mode:screen; filter:blur(6px);
  background:radial-gradient(120% 120% at 50% 50%, rgba(255,0,90,.55), rgba(255,0,90,0) 60%);
  animation:flashOverlay 1.6s ease-out 1
}
@keyframes neonBlink{
  0%{ box-shadow:0 0 0 3px rgba(255,72,108,1) inset,0 0 52px rgba(255,0,90,1),0 0 120px rgba(255,0,90,.9),0 0 160px rgba(255,0,90,.7) }
  18%{ box-shadow:0 0 0 3px rgba(255,72,108,.8) inset,0 0 18px rgba(255,0,90,.6),0 0 40px rgba(255,0,90,.4),0 0 80px rgba(255,0,90,.3) }
  32%{ box-shadow:0 0 0 3px rgba(255,72,108,1) inset,0 0 50px rgba(255,0,90,.95),0 0 120px rgba(255,0,90,.8),0 0 160px rgba(255,0,90,.6) }
  48%{ box-shadow:0 0 0 3px rgba(255,72,108,.75) inset,0 0 16px rgba(255,0,90,.5),0 0 36px rgba(255,0,90,.35),0 0 70px rgba(255,0,90,.25) }
  70%{ box-shadow:0 0 0 3px rgba(255,72,108,1) inset,0 0 42px rgba(255,0,90,.9),0 0 100px rgba(255,0,90,.7),0 0 140px rgba(255,0,90,.55) }
  100%{ box-shadow:0 0 0 3px rgba(255,72,108,.9) inset,0 0 28px rgba(255,0,90,.6),0 0 70px rgba(255,0,90,.4),0 0 110px rgba(255,0,90,.3) }
}
@keyframes flashOverlay{ 0%{opacity:0} 10%{opacity:1} 25%{opacity:.25} 45%{opacity:.95} 100%{opacity:0} }

/* Toast, tombol, editor icon (tetap) */
.toast{ position:fixed; right:clamp(16px,4vw,40px); bottom:clamp(16px,4vw,40px); z-index:70 }
.toast .card{ min-width:280px; max-width:460px; background:rgba(16,22,42,.92); border:1px solid rgba(56,189,248,.35); border-radius:.9rem; padding:1rem 1.25rem;
  box-shadow:0 10px 40px rgba(0,0,0,.55), 0 0 30px rgba(56,189,248,.25); transform:translateY(12px); opacity:0;
  transition:transform .28s ease, opacity .28s ease }
.toast.show .card{ transform:translateY(0); opacity:1 }
.toast.inline{ position:static; right:auto; bottom:auto }
.toast.inline .card{ margin-top:.75rem }
.toast h4{ font-weight:800; letter-spacing:.02em; margin:0 0 .35rem 0 }
.toast .btn{ margin-top:.6rem; padding:.5rem .9rem; border-radius:.6rem; background:linear-gradient(45deg, var(--p), var(--s)); color:#0b0f1a; font-weight:800; border:none }
.toast .btnRow{ display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap }
.toast .btnRow .btn{ flex:1; display:inline-block; text-align:center; margin-top:0; text-decoration:none }
.toast .btnRow .btn:hover{ filter:brightness(1.05) }

.miniBtn{ font-size:.82rem; padding:.35rem .7rem; border-radius:.5rem; background:linear-gradient(45deg,var(--p),var(--s)); color:#0b0f1a; font-weight:800; border:none }
.iconEditor{ margin-top:.6rem; padding:.75rem; border:1px dashed rgba(148,163,184,.35); border-radius:.75rem; background:rgba(2,8,23,.45) }
.iconEditor.hidden{ display:none }
.ieditRow{ display:grid; grid-template-columns: 1.2fr 2fr auto; align-items:center; gap:.5rem; margin-bottom:.5rem }
.ieditRow input{ padding:.45rem .6rem; border-radius:.5rem; border:1px solid rgba(148,163,184,.35); background:rgba(15,23,42,.8); color:var(--txt) }
.ieditRow button.apply{ padding:.4rem .65rem; border-radius:.45rem; background:rgba(56,189,248,.2); border:1px solid rgba(56,189,248,.45); color:var(--txt) }

.slotBox .backlight{ position:absolute; inset:var(--slotInset); border-radius:12px; background:
  radial-gradient(48% 55% at 50% 50%, rgba(255,255,255,.55), rgba(255,255,255,.35) 45%, transparent 70%),
  radial-gradient(40% 50% at 50% 48%, rgba(255,255,255,.25), transparent 70%); pointer-events:none; filter: saturate(1.1) brightness(1.25) }
.picker{ filter: drop-shadow(0 0 16px rgba(56,189,248,.7)) }
.display {
  position: absolute;
  inset: var(--slotInset);
  display: flex;
  align-items: center;
  justify-content: center;
  width: calc(100% - 2 * var(--slotInset));
  height: calc(100% - 2 * var(--slotInset));
}
.display .logo {
  width: clamp(120px, 28vw, 180px);
  height: clamp(120px, 28vw, 180px);
  object-fit: contain;
  filter: drop-shadow(0 8px 22px rgba(56,189,248,.45)) drop-shadow(0 0 28px rgba(168,85,247,.25));
  display: block;
  margin: auto;
}
.display .vcol{ position:absolute; inset:14px; display:flex; flex-direction:column; align-items:center; gap:18px; will-change:transform }
.display .vItem{ display:flex; flex-direction:column; align-items:center; gap:.35rem }
.display .vItem .logo{ width: clamp(90px, 24vw, 140px); height:auto; object-fit:contain }
.spinning .vItem .logo{ animation:coinSpin 240ms linear infinite }
@keyframes coinSpin{ from{ transform:rotateY(0deg) } to{ transform:rotateY(360deg) } }

/* cabinet (frame luar) */
.cabinet{ position:relative; width:min(520px,100%); background:linear-gradient(180deg,#1f2937,#0f172a 40%, #111827 60%, #0b1220);
  border-radius:18px; padding:14px 18px 18px; box-shadow: 0 30px 80px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.06) }
.cabinet:after{ content:""; position:absolute; left:10px; right:10px; bottom:10px; height:10px; border-radius:999px;
  background: radial-gradient(50% 80% at 50% 50%, rgba(0,0,0,.6), transparent 70%); filter: blur(6px); z-index:0 }
.marquee{
  height:64px; border-radius:12px; display:grid; place-items:center; font-family:'Bebas Neue',sans-serif; font-size:clamp(20px,3.2vw,32px);
  letter-spacing:.06em; color:#ffe; text-shadow:0 0 18px rgba(255,214,10,.5);
  background: radial-gradient(120% 120% at 50% 0%, rgba(255,214,10,.22), transparent 60%), linear-gradient(180deg,#0b0f1a,#0e1629);
  border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 -6px 18px rgba(0,0,0,.5), 0 0 24px rgba(56,189,248,.25);
  margin-bottom:12px; position:relative; overflow:hidden
}
.marquee span{ display:inline-block }

.window{ background:linear-gradient(180deg,#0d1227,#0f1b33); border-radius:12px; padding:var(--slotInset); border:1px solid rgba(226,232,240,.8); box-shadow: inset 0 0 40px rgba(255,255,255,.5); position:relative }
.deck{ display:flex; gap:10px; justify-content:center; padding-top:14px }
.btncap{ width:44px; height:16px; border-radius:3px; background:linear-gradient(180deg,#4b5563,#1f2937);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 3px 8px rgba(0,0,0,.6) }
.btncap.c1{ background:linear-gradient(180deg,#22d3ee,#164e63) }
.btncap.c2{ background:linear-gradient(180deg,#a78bfa,#4338ca) }
.btncap.c3{ background:linear-gradient(180deg,#10b981,#064e3b) }

.lever{ position:absolute; right:-28px; top:100px; width:16px; height:120px; border-radius:10px; background:linear-gradient(180deg,#0f1a39,#0b122a);
  border:1px solid rgba(255,255,255,.15); box-shadow: inset 0 0 24px rgba(167,139,250,.25); transform-origin: top center; transition: transform .2s ease }
.lever::after{
  content:""; position:absolute; bottom:-18px; left:50%; transform: translateX(-50%);
  width:36px; height:36px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fff,#ddd 15%, #cbd5e1 35%, #0ea5e9 36%, #0ea5e9 60%, #0b122a 61%);
  box-shadow: 0 0 28px rgba(34,211,238,.5), inset 0 0 22px rgba(255,255,255,.35);
  border:2px solid rgba(255,255,255,.14)
}
.lever.pull{ transform:rotate(14deg) }

.boardWrap{ position:relative; padding-top:3.2rem; margin-top:.25rem }
.boardHead{
  position:absolute; top:-1.1rem; left:50%; transform:translateX(-50%); z-index:5; width:fit-content; display:inline-flex; align-items:center; justify-content:center;
  padding:.55rem 1.25rem; border-radius:.9rem; font-family:'Bebas Neue',sans-serif; font-weight:900; letter-spacing:.08em; font-size:clamp(18px,1.8vw,22px);
  text-transform:uppercase; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.85), 0 0 12px rgba(255,255,255,.55);
  background: linear-gradient(180deg,#fffef8,#fff4d6); border:1px solid rgba(17,24,39,.15);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.95), 0 8px 22px rgba(0,0,0,.18), 0 0 26px rgba(255,255,255,.3)
}

:focus-visible{ outline:2px solid var(--p); outline-offset:3px }
</style>
</head>
<body>
  <header class="siteHeader" role="banner">
    <div class="spread">
      <div class="brand">BELEGENDBET</div>
      <a class="homeBtn" href="index.html">Beranda</a>
    </div>
  </header>

  <div class="subFooter">© 2025 BELEGENDBET. Hak Cipta Dilindungi Undang-Undang.</div>
  <div class="space" aria-hidden="true"><canvas id="stars"></canvas></div>

  <main class="shell relative pagePadAll">
    <section class="neon">
      <header class="text-center mb-6">
        <h1 class="title text-[clamp(2.2rem,7vw,4.6rem)]">CRYPTO TRADING DASHBOARD</h1>
        <p class="flex items-center justify-center gap-2 mt-3"><span class="dot" aria-hidden="true"></span> LIVE DATA STREAM</p>
      </header>

      <!-- Mini live chart -->
      <div class="miniChart mb-8">
        <div class="mc-head">
          <div class="mc-title">Mini Crypto Chart • <b>BELEGENDBET</b></div>
          <div class="mc-tools">
            <label class="mc-select"><span>Symbol</span>
              <select id="mcSymbol"></select>
            </label>
            <div class="mc-chips" id="mcTime">
              <button class="chip" data-win="60">1m</button>
              <button class="chip" data-win="300">5m</button>
              <button class="chip active" data-win="1800">30m</button>
              <button class="chip" data-win="3600">1h</button>
            </div>
            <div class="mc-chips">
              <label class="chip input">MA <input id="mcMA" type="number" value="20" min="2" max="200"></label>
              <label class="chip input">EMA <input id="mcEMA" type="number" value="50" min="2" max="200"></label>
            </div>
          </div>
        </div>
        <canvas id="liveChart" class="chart" aria-label="Live price"></canvas>
      </div>

      <div class="grid-2 mb-8">
        <div class="slotStage">
          <div class="cabinet">
            <div class="marquee"><span>CRYPTO WIN</span></div>
            <div class="window">
              <div class="slotBox">
                <div class="glare"></div><div class="backlight"></div><div class="frame"></div>
                <div id="display" class="display"></div>
                <div id="reel" class="reel"></div>
                <div class="picker" id="picker"></div>
              </div>
            </div>
            <div class="deck"><div class="btncap c1"></div><div class="btncap c2"></div><div class="btncap c3"></div><div class="btncap"></div><div class="btncap"></div></div>
            <div class="lever" id="lever"></div>
          </div>
          <div class="mt-4 flex gap-3">
            <button id="btn" class="cta" type="button">EXECUTE TRADE</button>
          </div>
        </div>

        <div>
          <div class="boardWrap">
            <div class="boardHead" id="boardHead">Daftar Hadiah</div>
            <div id="prizeBoard" class="board" aria-labelledby="boardHead"></div>
          </div>

          <!-- TOAST: 2 tombol klaim sejajar -->
          <div id="toast" class="toast inline" role="status" aria-live="polite">
            <div class="card">
              <h4 id="tTitle">TRADE SUCCESS!</h4>
              <p id="tMsg" class="text-sm opacity-90"></p>
              <div class="btnRow" role="group" aria-label="Claim buttons">
                <a class="btn" href="https://klikblg.com/wa-blb" target="_blank" rel="noopener">CLAIM HADIAH WA</a>
                <a class="btn" href="https://t.me/asupanfreebet" target="_blank" rel="noopener">CLAIM HADIAH TELEGRAM</a>
              </div>
            </div>
          </div>
          <!-- END TOAST -->
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="mTitle" aria-describedby="mMsg">
    <div class="modal text-center">
      <h2 id="mTitle" class="text-2xl font-bold">TRADE SUCCESS!</h2>
      <p id="mMsg" class="mt-3"></p>
      <div class="mt-6"><button id="ok" class="cta" type="button">Close</button></div>
    </div>
  </div>

<script>
/* ======= JS ASLI (tidak diubah) ======= */
// ===== Helpers =====
const qs = (id)=>document.getElementById(id);
const formatIDR = (n)=> 'Rp. ' + Number(n||0).toLocaleString('id-ID');
// === Session & anti-double-claim ===
function loadSession(){ try{ return JSON.parse(localStorage.getItem('tm_session')||'null'); }catch{ return null } }
const s = loadSession();
function setClaimed(kupon) { if (!kupon) return; localStorage.setItem('tm_claimed_'+kupon, '1'); }
function isClaimed(kupon) { if (!kupon) return false; return localStorage.getItem('tm_claimed_'+kupon) === '1'; }

// Saat halaman dibuka, cek status kupon ke API
async function checkKuponStatus() {
  if (!s?.userId || !s?.kupon) return;
  const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
  try {
    const res = await fetch(`${apiUrl}?action=claim&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`);
    const data = await res.json();
    if (data.msg && data.msg.toLowerCase().includes('terpakai')) {
      disableGame();
      showToast('INFO', 'Kupon sudah pernah dipakai!');
      setClaimed(s.kupon);
    }
  } catch (e) {}
}
function disableGame() {
  btn.disabled = true;
  btn.textContent = 'SELESAI';
  if(lever) lever.style.pointerEvents = 'none';
}
if (isClaimed(s?.kupon)) {
  disableGame();
  showToast('INFO', 'Kupon sudah pernah dipakai!');
} else {
  checkKuponStatus();
}

// ===== Data =====
const symbols=[
  { name:'Bitcoin (BTC)',   icon:'https://i.postimg.cc/7PfjhkQs/compressed-BTC.webp', prize:1500000 },
  { name:'Ethereum (ETH)',  icon:'https://i.postimg.cc/g2P7g6cQ/compressed-ETH.webp', prize:500000 },
  { name:'Dogecoin (DOGE)', icon:'https://i.postimg.cc/rpfYynG2/doge.webp', prize:100000 },
  { name:'Cardano (ADA)',   icon:'https://i.postimg.cc/Pq527Wg3/ada.webp', prize:50000 },
  { name:'Solana (SOL)',    icon:'https://i.postimg.cc/kXPwCPrt/sol.webp', prize:10000 },
  { name:'Litecoin (LTC)',  icon:'https://i.postimg.cc/YCp34NCr/ltc.webp', prize:8000 },
  { name:'Ripple (XRP)',    icon:'https://i.postimg.cc/44VbB2K4/xrp.webp', prize:5000 },
  { name:'Binance Coin (BNB)', icon:'https://i.postimg.cc/MTkfBxm7/bnb.webp', prize:3000 },
  { name:'Polkadot (DOT)',  icon:'https://i.postimg.cc/2j7L1sbW/dot.webp', prize:2000 }
];

// ===== Elements =====
const reel=qs('reel'), btn=qs('btn'), boardEl=qs('prizeBoard'), overlay=qs('overlay'),
  mTitle=qs('mTitle'), mMsg=qs('mMsg'), okBtn=qs('ok'), picker=qs('picker'), lever=qs('lever'),
  display=qs('display'), editBtn=qs('editIcons'), iconEditor=qs('iconEditor');
const toast=qs('toast'), tTitle=qs('tTitle'), tMsg=qs('tMsg'), tClose=qs('tClose'); // tClose null = aman
const REM=parseFloat(getComputedStyle(document.documentElement).fontSize);

// ===== Auto-hide toast (5 detik) =====
let toastTimer;
function showToast(title, msg){
  tTitle.textContent = title;
  tMsg.textContent = msg;
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
}
function hideToast(){
  if (toastTimer){ clearTimeout(toastTimer); toastTimer=null; }
  toast.classList.remove('show');
}
if(tClose){ tClose.addEventListener('click', hideToast); }

// ===== Preload icons =====
async function preloadIcons(){
  const urls = [...new Set(symbols.map(s=>s.icon))];
  await Promise.all(urls.map(src => new Promise(res=>{
    const im = new Image();
    im.decoding = 'sync';
    im.loading = 'eager';
    im.crossOrigin = 'anonymous';
    im.referrerPolicy = 'no-referrer';
    im.src = src;
    im.onload = im.onerror = res;
  })));
}

// ===== Helper tunggu gambar =====
function waitImagesOrTimeout(root, ms=1200){
  const imgs = [...root.querySelectorAll('img')].filter(im=>!im.complete);
  if(!imgs.length) return Promise.resolve();
  return Promise.race([
    Promise.all(imgs.map(im=>new Promise(r=>{ im.onload=r; im.onerror=r; }))),
    new Promise(r=>setTimeout(r, ms))
  ]);
}

// ===== State & Config =====
let CELL_H=18*REM, CENTER_OFF=0, baseIndex=0, spinning=false, lastPick=-1;
const LOOPS=10;
const SPIN_FAST_MS=3500;
const LANDING_MS=1400;
const ACTIVE_SPIN_MS=650;
const SEQ_MIN=12, SEQ_MAX=18;

// ===== UI Wiring =====
okBtn.addEventListener('click',()=>overlay.style.display='none');
btn.addEventListener('click', startSpin);
if(lever){
  lever.addEventListener('click', ()=>{
    if(!spinning){
      lever.classList.add('pull');
      setTimeout(()=>lever.classList.remove('pull'), 400);
      startSpin();
    }
  });
  lever.addEventListener('keydown', (e)=>{
    if((e.key==='Enter'||e.key===' ') && !spinning){
      e.preventDefault();
      lever.click();
    }
  });
}
addEventListener('resize', ()=>{ measureCell(); applyBaseTransform(); });
addEventListener('pointermove', (e)=>{
  const x = e.clientX / innerWidth;
  const y = e.clientY / innerHeight;
  document.body.style.setProperty('--mx', Math.round(x*100)+'%');
  document.body.style.setProperty('--my', Math.round(y*100)+'%');
});

// ===== Prize Board =====
function renderPrizeBoard(){
  boardEl.innerHTML='';
  symbols.forEach((s,i)=>{
    const r=document.createElement('div');
    r.className='row';
    r.dataset.idx=i;

    const img=document.createElement('img');
    img.src=s.icon; img.alt=s.name;
    img.loading='eager'; img.decoding='sync'; img.setAttribute('fetchpriority','high');
    img.width=110; img.height=110;

    const name=document.createElement('div');
    name.className='name';
    name.textContent=s.name;

    const amt=document.createElement('div');
    amt.className='amt';
    amt.textContent=formatIDR(s.prize);

    r.appendChild(img); r.appendChild(name); r.appendChild(amt);
    boardEl.appendChild(r);
  });
}
function setActiveRow(i){
  boardEl.querySelectorAll('.row').forEach(el=>el.classList.toggle('active', Number(el.dataset.idx)===i));
  const row = boardEl.querySelector(`.row[data-idx="${i}"]`);
  if(row){ row.scrollIntoView({block:'nearest', behavior:'smooth'}); }
}
function markWin(i){
  boardEl.querySelectorAll('.row').forEach(el=>{
    const hit = Number(el.dataset.idx)===i;
    el.classList.toggle('win', hit);
    if(hit){
      el.classList.remove('flash');
      void el.offsetWidth;
      el.classList.add('flash');
      setTimeout(()=> el.classList.remove('flash'), 1700);
    } else {
      el.classList.remove('flash');
    }
  });
}

// ===== Reel Build & Measure =====
function recalcCenter(){ const rect=reel.parentElement.getBoundingClientRect(); CENTER_OFF = Math.max(0,(rect.height-CELL_H)/2); }
function measureCell(){ const first = reel.children[0]; if(first){ CELL_H = first.getBoundingClientRect().height || 18*REM; } recalcCenter(); }

async function populate(){
  reel.innerHTML='';
  const arr = Array.from({length: LOOPS}, ()=> symbols).flat();
  for(const s of arr){
    const d=document.createElement('div');
    d.className='cell';
    const img = document.createElement('img');
    img.src=s.icon; img.alt=s.name;
    img.loading='eager'; img.decoding='sync'; img.setAttribute('fetchpriority','high');
    img.width=110; img.height=110;
    img.addEventListener('error',()=>{
      d.innerHTML = `<div style="width:110px;height:110px;border-radius:999px;display:grid;place-items:center;background:linear-gradient(135deg,#38bdf8,#a855f7);color:#0b0f1a;font-weight:900;">${(s.name.split('(')[1]?.replace(')','')||'??')}</div>`;
    });
    d.appendChild(img);
    const label = document.createElement('span'); label.textContent = s.name; d.appendChild(label);
    reel.appendChild(d);
  }

  await waitImagesOrTimeout(reel, 1200);

  measureCell();
  baseIndex=symbols.length*Math.floor(LOOPS/2);
  reel.style.transition='none';
  applyBaseTransform();
  renderDisplay(symbols[0]);
}
function applyBaseTransform(){ reel.style.transform=`translate3d(0, -${baseIndex*CELL_H - CENTER_OFF}px, 0)`; }

// ===== Spin Logic =====
function getAllowedIndices(){ return symbols.map((s,i)=> (s.prize>=2000 && s.prize<=10000) ? i : -1).filter(i=>i>=0); }
function pickAllowed(){ const a=getAllowedIndices(); return a[Math.floor(Math.random()*a.length)]; }
function calcLandingIndex(currentStep,targetIdx,perRound){
  const stepMod=currentStep%perRound; const delta=(targetIdx-stepMod+perRound)%perRound; return currentStep+perRound*2+delta;
}
function flashPicker(){ picker.animate([{opacity:1},{opacity:0.25},{opacity:1}],{duration:520,iterations:3}); picker.style.opacity=1; }

// === DISPLAY (top->bottom logo column) ===
function renderDisplay(sym){
  display.innerHTML = '';
  const im = document.createElement('img');
  im.className='logo';
  im.src = sym.icon;
  im.alt = sym.name;
  im.loading='eager'; im.decoding='sync'; im.setAttribute('fetchpriority','high');
  im.width=180; im.height=180;
  display.appendChild(im);
}
function buildColumn(order){
  display.innerHTML = '<div class="vcol" id="vcol"></div>';
  const col = document.getElementById('vcol');
  order.forEach(i=>{
    const s = symbols[i];
    const el = document.createElement('div');
    el.className='vItem';
    const im = document.createElement('img');
    im.className='logo';
    im.src=s.icon; im.alt=s.name;
    im.loading='eager'; im.decoding='sync'; im.setAttribute('fetchpriority','high');
    im.width=140; im.height=140;
    el.appendChild(im);
    col.appendChild(el);
  });
  return col;
}

function startSpin(){
  display.classList.add('spinning');
  if(lever){ lever.classList.add('pull'); setTimeout(()=>lever.classList.remove('pull'), 400); }
  if(spinning) return;
  spinning=true; btn.disabled=true; btn.textContent='EXECUTING...';

  const per=symbols.length, current=baseIndex;
  let finalIdx=pickAllowed();
  if(finalIdx===current%per) finalIdx=(finalIdx+1)%per;
  lastPick=finalIdx; setActiveRow(finalIdx);

  const seqLen = SEQ_MIN + Math.floor(Math.random()*(SEQ_MAX-SEQ_MIN+1));
  const order = [];
  for(let k=0;k<seqLen-1;k++){ order.push(Math.floor(Math.random()*per)); }
  order.push(finalIdx);

  const col = buildColumn(order);
  const item = col.children[0];
  const h = item.getBoundingClientRect().height;
  const centerY = display.clientHeight/2;
  const endY = centerY - ((order.length-1)*h + h/2);
  const stepLead = 6;
  const startY = endY - h * stepLead;
  const duration = ACTIVE_SPIN_MS;

  col.style.transition='none';
  col.style.transform = `translateY(${startY}px)`;
  requestAnimationFrame(()=>{ requestAnimationFrame(()=>{
    col.style.filter='brightness(1.05) blur(1px)';
    col.style.transition = `transform ${duration}ms cubic-bezier(.2,.95,.25,1)`;
    col.style.transform = `translateY(${endY}px)`;
  });});

  const onEnd = (e)=>{
    if(e.propertyName!=='transform') return;
    col.removeEventListener('transitionend', onEnd);
    col.style.filter='none';
    display.classList.remove('spinning');
    finishSpin(symbols[finalIdx], finalIdx);
  };
  col.addEventListener('transitionend', onEnd);
}

function finishSpin(sym, idx){
  spinning=false; btn.disabled=true; btn.textContent='SELESAI';
  if (!s?.userId || !s?.kupon) {
    showToast('ERROR', 'Session tidak valid. Silakan login ulang.');
    return;
  }
  if (isClaimed(s.kupon)) {
    showToast('INFO', 'Kupon sudah pernah dipakai!');
    disableGame();
    return;
  }
  const apiUrl = 'https://script.google.com/macros/s/AKfycbyRl2BqiDPw75fQ-XYyL87eKDwHMr61eY0Cg7ra1vc36OMOFZ3IRY_QeZcLFDzFFM88/exec';
  const url = `${apiUrl}?action=catat&userid=${encodeURIComponent(s.userId)}&kupon=${encodeURIComponent(s.kupon)}&site=BELEGENDBET`;
  fetch(url)
    .then(async res => {
      let data;
      try { data = await res.json(); } catch(e) { data = {success:false, msg:'Response bukan JSON'}; }
      if (data.success) {
        let hadiahNum = Number(data.hadiah);
        let idxServer = symbols.findIndex(sy => Number(sy.prize) === hadiahNum);
        if(idxServer === -1) idxServer = idx;
        renderDisplay(symbols[idxServer]);
        markWin(idxServer); flashPicker();
        mTitle.textContent = 'TRADE SUCCESS!';
        mMsg.textContent = `Profit ${formatIDR(hadiahNum)} dari ${symbols[idxServer].name}`;
        showToast('SUKSES', `Hadiah ${formatIDR(hadiahNum)} (${symbols[idxServer].name}) sudah dicatat!`);
        setClaimed(s.kupon);
        disableGame();
      } else {
        showToast('ERROR', data.msg || 'Gagal mencatat hadiah!');
        disableGame();
      }
    })
    .catch(() => {
      showToast('ERROR', 'Gagal menghubungi server. Coba lagi.');
      disableGame();
    });
}

// ===== Stars BG =====
(function stars(){
  const c = qs('stars');
  const ctx = c.getContext('2d');
  function resize(){ c.width = innerWidth * devicePixelRatio; c.height = innerHeight * devicePixelRatio; }
  resize(); addEventListener('resize', resize);
  const N = 160;
  const stars = new Array(N).fill(0).map(()=>({ x: Math.random()*c.width, y: Math.random()*c.height, z: Math.random()*1+0.3, r: Math.random()*1.4+0.3 }));
  let t=0;
  function loop(){
    t+=0.016; ctx.clearRect(0,0,c.width,c.height);
    for(const s of stars){
      s.y += s.z*0.6; if(s.y>c.height) s.y = 0;
      ctx.globalAlpha = 0.6 + Math.sin((s.x+s.y+t*30)/99)*0.2;
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r*devicePixelRatio,0,Math.PI*2);
      ctx.fillStyle = '#7dd3fc'; ctx.fill();
    }
    requestAnimationFrame(loop);
  }
  loop();
})();

// ===== Live Chart =====
(function liveChart(){
  const cv = qs('liveChart');
  const ctx = cv.getContext('2d');
  const tfWrap = document.getElementById('mcTime');
  const sel = document.getElementById('mcSymbol');
  const maInp = document.getElementById('mcMA');
  const emaInp = document.getElementById('mcEMA');

  function tickerFromName(name){
    const m = name.match(/\(([^)]+)\)/);
    return (m? m[1].toUpperCase(): name.split(' ')[0].toUpperCase()) + 'USDT';
  }
  const tickers = symbols.map(s=>({ label: tickerFromName(s.name), value: tickerFromName(s.name) }));
  sel.innerHTML = tickers.map(t=>`<option value="${t.value}">${t.label}</option>`).join('');

  let candles = [];
  let base = 68000;
  let last = base;
  let winSec = 1800;
  let maP = 20, emaP = 50;
  const bases = { BTCUSDT:68000, ETHUSDT:3600, DOGEUSDT:0.12, ADAUSDT:0.6, SOLUSDT:150, LTCUSDT:80, XRPUSDT:0.55, BNBUSDT:420, DOTUSDT:7.5 };

  function seed(n=240){
    candles.length=0;
    let p = last = base;
    const now = Date.now();
    for(let i=n;i>0;i--){
      const v = (Math.random()-0.5);
      const vol = Math.max(0.0005*base, base*0.002);
      const o = p;
      const c = Math.max(0.0000001, o + v*vol);
      const h = Math.max(o,c) + Math.random()*vol*0.6;
      const l = Math.min(o,c) - Math.random()*vol*0.6;
      p = c;
      candles.push({ t: Math.floor((now - i*1000)/1000), o,h,l,c });
    }
  }
  function setSymbol(sym){ base = bases[sym] || 1000; last = base; seed(3600); draw(); window.__chartSym = sym; }
  setSymbol(sel.value || tickers[0].value); sel.value = sel.value || tickers[0].value;

  let dpr = 1;
  function resize(){ dpr = devicePixelRatio||1; cv.width = cv.clientWidth*dpr; cv.height = cv.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); draw(); }
  addEventListener('resize', resize); resize();

  function tick(){
    const vol = Math.max(0.0005*base, base*0.002);
    const o = last;
    const drift = (Math.random()-0.5)*vol*1.6;
    const c = Math.max(0.0000001, o + drift);
    const h = Math.max(o,c) + Math.random()*vol*0.6;
    const l = Math.min(o,c) - Math.random()*vol*0.6;
    last = c;
    candles.push({ t: Math.floor(Date.now()/1000), o,h,l,c });
    if(candles.length>20000) candles.shift();
    draw();
  }
  setInterval(tick, 1000);

  function SMA(arr, p){
    const out=[]; let sum=0;
    for(let i=0;i<arr.length;i++){
      sum+=arr[i]; if(i>=p) sum-=arr[i-p];
      out.push(i>=p-1? sum/p: NaN);
    }
    return out;
  }
  function EMA(arr, p){
    const out=[]; const k=2/(p+1); let prev=arr[0]||0;
    for(let i=0;i<arr.length;i++){
      const v= i? (arr[i]*k + prev*(1-k)) : arr[i];
      out.push(i? v: NaN); prev=v;
    }
    return out;
  }

  function formatPrice(v){ if(v>=1000) return Math.round(v).toLocaleString('en-US'); if(v>=1) return v.toFixed(2); return v.toFixed(4); }
  function tsToLabel(ts){ const d=new Date(ts*1000); const m=d.getMinutes().toString().padStart(2,'0'); return `${d.getHours()}:${m}`; }

  function draw(){
    if(!cv || !cv.clientWidth){ return; }
    const view = candles.slice(-winSec);
    const w = cv.clientWidth, h = cv.clientHeight;
    ctx.clearRect(0,0,w,h);
    if(view.length<2){ window.__chartReady=true; return; }

    const highs = view.map(c=>c.h), lows = view.map(c=>c.l);
    const ymax = Math.max(...highs); const ymin = Math.min(...lows);
    const pad = (ymax - ymin)*0.08 + 1e-9;
    const max=ymax+pad, min=ymin-pad;
    const n = view.length; const cw = Math.max(2, w/n*0.7);

    ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    const rows=4, cols=8;
    for(let r=1;r<rows;r++){ const y=h*r/rows; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    for(let c=1;c<cols;c++){ const x=w*c/cols; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }

    function xy(i,v){ const x=i/(n-1)*w; const y=h - (v-min)/(max-min)*h; return [x,y]; }

    for(let i=0;i<n;i++){
      const c = view[i];
      const [xOpen,yOpen] = xy(i,c.o);
      const [xClose,yClose] = xy(i,c.c);
      const [xHigh,yHigh] = xy(i,c.h);
      const [xLow,yLow] = xy(i,c.l);
      const x = xOpen; const up = c.c>=c.o;
      ctx.strokeStyle = up? 'rgba(34,197,94,0.95)':'rgba(239,68,68,0.95)';
      ctx.fillStyle   = up? 'rgba(34,197,94,0.35)':'rgba(239,68,68,0.35)';
      ctx.beginPath(); ctx.moveTo(x,yHigh); ctx.lineTo(x,yLow); ctx.stroke();
      const bx = x - cw/2; const by = Math.min(yOpen,yClose); const bh = Math.max(1, Math.abs(yClose - yOpen));
      ctx.fillRect(bx, by, cw, bh); ctx.strokeRect(bx, by, cw, bh);
    }

    const closes = view.map(c=>c.c);
    const sma = SMA(closes, maP);
    const ema = EMA(closes, emaP);
    function line(arr, color){
      ctx.beginPath();
      for(let i=0;i<arr.length;i++){
        const v = arr[i]; if(!isFinite(v)) continue;
        const [x,y]=xy(i,v);
        if(i===0||!isFinite(arr[i-1])) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.lineWidth=1.6; ctx.strokeStyle=color; ctx.shadowColor=color.replace('1)','0.25)'); ctx.shadowBlur=6; ctx.stroke(); ctx.shadowBlur=0;
    }
    line(sma, 'rgba(167,139,250,1)');
    line(ema, 'rgba(96,165,250,1)');

    const lastPx = closes[closes.length-1];
    const [xr, yr] = xy(n-1,lastPx);
    const tag = formatPrice(lastPx);
    const textW = ctx.measureText(tag).width;
    ctx.fillStyle='rgba(17,24,39,0.85)'; ctx.strokeStyle='rgba(99,102,241,.6)'; ctx.lineWidth=1;
    ctx.fillRect(w - textW - 6*2 - 8, yr-10, textW + 6*2, 20);
    ctx.strokeRect(w - textW - 6*2 - 8, yr-10, textW + 6*2, 20);
    ctx.fillStyle='#e5edff'; ctx.font='12px Roboto Mono';
    ctx.fillText(tag, w - textW - 6 - 8, yr+4);

    ctx.fillStyle='rgba(148,163,184,.9)'; ctx.font='11px Roboto Mono';
    for(let i=0;i<=6;i++){
      const idx=Math.floor(i/6*(n-1));
      const t=view[idx].t;
      const [x,y]=xy(idx, min);
      ctx.fillText(tsToLabel(t), x-10, h-6);
    }
    window.__chartReady = true;
  }

  tfWrap.querySelectorAll('.chip').forEach(b=>{
    b.addEventListener('click',()=>{
      tfWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.addEventListener; b.classList.add('active');
      const win = Number(b.dataset.win)||1800; winSec = win; draw();
    });
  });
  maInp.addEventListener('change',()=>{ maP = Math.max(2, Math.min(200, Number(maInp.value)||20)); draw(); });
  emaInp.addEventListener('change',()=>{ emaP = Math.max(2, Math.min(200, Number(emaInp.value)||50)); draw(); });
  sel.addEventListener('change',()=>{ setSymbol(sel.value); });
})();

// ===== Boot =====
(()=>{
  renderPrizeBoard();
  populate();
  preloadIcons();
})();
</script>
</body>
</html>
